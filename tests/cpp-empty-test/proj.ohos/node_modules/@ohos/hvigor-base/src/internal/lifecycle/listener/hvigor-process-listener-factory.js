"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.hvigorProcessListenerFactory=exports.HvigorProcessListenerFactory=void 0;const sync_js_1=require("../sync.js"),process_1=__importDefault(require("process")),hvigor_process_js_1=require("../hvigor-process.js"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),lodash_1=require("lodash"),global_data_js_1=require("../../data/global-data.js"),event_id_options_js_1=require("../event/event-id-options.js"),hvigor_log_js_1=require("../../../log/hvigor-log.js"),time_util_js_1=require("../../../util/time-util.js"),trace_build_analyze_js_1=require("../../../trace/trace-build-analyze.js"),replacer_js_1=require("../../../util/replacer.js"),index_js_1=require("../../../../index.js"),project_cache_service_js_1=require("../../cache/project-cache-service.js"),log=hvigor_log_js_1.HvigorLogger.getLogger("hvigor-process-listener-factory");class HvigorProcessListenerFactory{getProcessListenerByEventName(e){switch(e){case event_id_options_js_1.HVIGOR_PROCESS_EVENT_ID.FINISHED:return this.getFinishedEventListener();case event_id_options_js_1.HVIGOR_PROCESS_EVENT_ID.FAILED:return this.getFailedEventListener();default:return lodash_1.noop}}getFailedEventListener(){return()=>{const e=global_data_js_1.globalData.cliEnv,r=process_1.default.hrtime(hvigor_process_js_1.hvigorProcess.taskBeginTime),t=(0,time_util_js_1.formatTime)(r);log.error(`BUILD FAILED in ${t}`),exitHvigor(-1,e.cwd,1e9*r[0]+r[1])}}getFinishedEventListener(){const e=global_data_js_1.globalData.cliOpts,r=global_data_js_1.globalData.cliEnv;return e.sync?()=>{(0,sync_js_1.outputPluginSyncInfo)(),process_1.default.exit(0)}:()=>{const e=process_1.default.hrtime(hvigor_process_js_1.hvigorProcess.taskBeginTime),t=(0,time_util_js_1.formatTime)(e);hvigor_process_js_1.hvigorProcess.hasTaskDone||log.error("The task to be executed in the project cannot be found. Please check."),log.info(`BUILD SUCCESSFUL in ${t}`),exitHvigor(0,r.cwd,1e9*e[0]+e[1])}}}function traceEnd(e,r){trace_build_analyze_js_1.traceBuildAnalyze.totalTime=r;const t=".hvigor/outputs/logs/details";fs_extra_1.default.existsSync(path_1.default.resolve(e,t))||fs_extra_1.default.mkdirSync(path_1.default.resolve(e,t),{recursive:!0});try{fs_extra_1.default.writeFileSync(path_1.default.resolve(e,t,"details.json"),JSON.stringify(trace_build_analyze_js_1.traceBuildAnalyze,replacer_js_1.replacer,2))}catch(e){}}function exitHvigor(e,r,t){const s=index_js_1.hvigor.getProject();project_cache_service_js_1.ProjectCacheService.getInstance(s).close(),traceEnd(r,t);index_js_1.ReportServiceImpl.getInstance().report(),process_1.default.exit(e)}exports.HvigorProcessListenerFactory=HvigorProcessListenerFactory,exports.hvigorProcessListenerFactory=new HvigorProcessListenerFactory;