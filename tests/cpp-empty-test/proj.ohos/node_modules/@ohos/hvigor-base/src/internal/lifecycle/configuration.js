"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.configuration=void 0;const path_1=__importDefault(require("path")),global_data_js_1=require("../data/global-data.js"),process_1=__importDefault(require("process")),fs_1=__importDefault(require("fs")),hvigor_log_js_1=require("../../log/hvigor-log.js"),index_js_1=require("../../../index.js"),time_util_js_1=require("../../util/time-util.js"),task_tree_js_1=require("../task/build/task-tree.js"),_log=hvigor_log_js_1.HvigorLogger.getLogger("hvigor-configuration");function configuration(){const e=process_1.default.hrtime(),o=global_data_js_1.globalData.cliEnv,i=index_js_1.hvigor.getProject();for(const e of i.getAllSubModules()){const o=e.getBuildFilePath();configNodeTask(e),evaluateNodeVigorFile(e,o)}const t=path_1.default.resolve(o.cwd,index_js_1.HvigorCommonConst.BUILD_FILE_NAME);configNodeTask(i),evaluateNodeVigorFile(i,t);const r=process_1.default.hrtime(e),s=(0,time_util_js_1.formatTime)(r);return _log.debug(`Configuration phase cost:${s}`),i}function configNodeTask(e){e.registry(new index_js_1.Tasks(e)),e.registry(new task_tree_js_1.TaskTree(e))}function findRealHvigorFilePath(e){for(const o of index_js_1.HvigorCommonConst.BUILD_FILE_NAME_SUFFIX){const i=`${e}${o}`;if(fs_1.default.existsSync(i))return i}}function evaluateNodeVigorFile(e,o){const i=findRealHvigorFilePath(o);i||_log.errorMessageExit(`Hvigorfile not found: ${o}.ts/js`);const t=require(i);if("function"==typeof t){const o=t(e);e.bindPlugin(o)}else t instanceof index_js_1.HvigorPlugin||Object.keys(t).forEach((o=>{const i=t[o];if(i instanceof index_js_1.HvigorPlugin)e.bindPlugin(i);else if("function"==typeof i){const o=i(e);e.bindPlugin(o)}}))}exports.configuration=configuration;