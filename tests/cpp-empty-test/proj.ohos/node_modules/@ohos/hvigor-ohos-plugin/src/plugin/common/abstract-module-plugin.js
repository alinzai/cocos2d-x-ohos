"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractModulePlugin=void 0;const module_task_service_js_1=require("../../tasks/service/module-task-service.js"),legacy_project_model_impl_js_1=require("../../model/project/legacy-project-model-impl.js"),project_model_impl_js_1=require("../../model/project/project-model-impl.js"),hvigor_base_1=require("@ohos/hvigor-base"),hap_extra_info_js_1=require("../../project/data/hap-extra-info.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),clean_js_1=require("../../tasks/common/clean.js"),compile_native_hook_js_1=require("../../tasks/hook/native/compile-native-hook.js"),default_plugin_id_js_1=require("./default-plugin-id.js"),module_task_service_factory_js_1=require("../../tasks/service/module-task-service-factory.js"),target_task_service_js_1=require("../../tasks/service/target-task-service.js"),common_const_js_1=require("../../const/common-const.js"),path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra")),ohosTestTargetName=common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET;class AbstractModulePlugin extends hvigor_base_1.HvigorPlugin{constructor(e,t,o){super(e),this._log=ohos_logger_js_1.OhosLogger.getLogger(AbstractModulePlugin.name),this._module=t,this.isFaMode=o,this._needExecTargetServiceList=[];const i=t.getProject();this._projectModel=this.isFaMode?legacy_project_model_impl_js_1.LegacyProjectModelImpl.getInstance(i):project_model_impl_js_1.ProjectModelImpl.getInstance(i),this._moduleModel=this._projectModel.getModuleModelByName(this._module.getName()),this.checkModule(),this._moduleService=module_task_service_factory_js_1.moduleTaskFactory.initModuleTaskService(this._projectModel,this._moduleModel,o),this.initTargetDepends(),this.initCommonTasks(),this.initCommonHookTasks(),this.initTasks()}initTargetDepends(){let e,t=!1;this._moduleService.getTargetDataSet().forEach((o=>{const i=o[0];if(e=i.getProduct().name,o[1]){t=!0;const e=new target_task_service_js_1.TargetTaskService(i);this._needExecTargetServiceList.push(e)}}));this._moduleService.getModuleModel().isHarModule()||t||this._log.warn(`Current product is '${e}'.No executable target in ${this._module.getName()}.`)}initCommonTasks(){this.clean=new clean_js_1.Clean(this._module,this._moduleService),this._module.registry(this.clean)}initCommonHookTasks(){this.compileNative=new compile_native_hook_js_1.CompileNativeHook(this._moduleService),this._needExecTargetServiceList.forEach((e=>{var t;null===(t=this.compileNative)||void 0===t||t.initTaskDepends(e)})),this._module.registry(this.compileNative)}checkModuleTarget(){const e=this._projectModel.getModuleSpecificTargets().get(this._moduleModel.getName());e&&e.filter((e=>"all"!==e)).forEach((e=>{(0,module_task_service_js_1.getOrDefaultTargets)(this._moduleModel).filter((t=>t.name===e)).length>0||this._log._buildError(`The module target '${e}' is not found in the '${this._module.getName()}'.`)._solution("Please check the command or module target configuration.")._printErrorAndExit()})),(0,module_task_service_js_1.getOrDefaultTargets)(this._moduleModel).forEach((e=>{const t=this.getTargetConfigFilePath(e.name);fs_extra_1.default.existsSync(t)||this._log._buildError(`The configuration file '${t}' for the target '${e.name}' is not found in the '${this._module.getName()}' module.`)._solution(`Please create the '${t}' configuration file.`)._printErrorAndExit()}))}getTargetConfigFilePath(e){const t=path_1.default.resolve(this._module.getNodeDir(),"src",e===ohosTestTargetName?ohosTestTargetName:"main");return this._moduleModel.getApiType()===hap_extra_info_js_1.ApiType.FA?path_1.default.resolve(t,common_const_js_1.CommonConst.CONFIG_JSON):path_1.default.resolve(t,common_const_js_1.CommonConst.MODULE_JSON5)}checkModule(){const e=this.pluginId===default_plugin_id_js_1.DefaultPluginId.OHOS_HAP_PLUGIN,t=this.isFaMode?hap_extra_info_js_1.ApiType.FA:hap_extra_info_js_1.ApiType.STAGE;void 0!==this._moduleModel&&this._moduleModel.getApiType()===t||this._log._buildError("Mismatch with apiType.")._solution(`Verify the settings in the hvigorfile or set apiType in the build-profile.json5 file to '${t}'.`)._file(this._module.getBuildFilePath())._printErrorAndExit(this._moduleModel?this._moduleModel.getName():"project"),this.checkModuleTarget(),this._moduleModel.isHapModule()!==e&&this._log._buildError("The plugin referenced in the hvigorfile does not match moduleType in the module.json5/config.json file. This may occur when the build-profile.json5 file is directly copied from a module, or when the hvigorfile has different task types registered, for example, hapTasks for a HAR module.")._solution("Make sure the module type set in build-profile.json5 is consistent with the settings of hvigorfile.")._file(this._module.getBuildFilePath())._printErrorAndExit(this._moduleModel.getName())}getTaskService(){return this._moduleService}}exports.AbstractModulePlugin=AbstractModulePlugin;