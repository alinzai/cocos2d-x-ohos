"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DependencyManager=void 0;const path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra")),resolve_package_path_1=__importDefault(require("resolve-package-path")),common_const_js_1=require("../../const/common-const.js"),error_url_js_1=require("../../utils/error-url.js"),project_file_reader_js_1=require("../../utils/project-file-reader.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),module_dependency_info_js_1=require("./module-dependency-info.js"),default_npm_dependency_js_1=require("./core/default-npm-dependency.js"),default_module_dependency_js_1=require("./core/default-module-dependency.js"),log=ohos_logger_js_1.OhosLogger.getLogger("ohos-dependency-manager"),solution=`The OpenHarmony npm package or module is not compatible with the current model. Use a compatible OpenHarmony npm package or module. For details about the stage and FA models, see ${error_url_js_1.ErrorUrl.ERROR_URL.ModelDiff}.`;class DependencyManager{constructor(e,o,t){this._log=ohos_logger_js_1.OhosLogger.getLogger(DependencyManager.name),this._allDependency=new Set,this._isFaMode=e,this._model=o,this._moduleName=o.getName(),this._projectModel=t}createModelDependencyInfo(){this._allDependency.clear();const e=[],o=new Map;return this.collectHarDependency(this._model.getPackageJsonPath(),o,e),this._projectModel&&this._model.isHapModule()&&this.collectHarDependency(this._projectModel.getPackageJsonPath(),o,e),this._log.debug(`Module ${this._moduleName} Collected Dependency: ${e.map((e=>e.getDependencyRootPath()))}`),new module_dependency_info_js_1.ModuleDependencyInfo(o,e)}collectHarDependency(e,o,t){const n=[e];for(;n.length>0;){const e=n.shift(),r=fs_extra_1.default.readJsonSync(e,{throws:!1});if(null!==r&&void 0!==r.name){this._allDependency.add(r.name);for(const s in null==r?void 0:r.dependencies)if(Object.prototype.hasOwnProperty.call(null==r?void 0:r.dependencies,s)){const r=(0,resolve_package_path_1.default)(s,path_1.default.dirname(e));if(null===r)continue;const a=fs_extra_1.default.readJsonSync(r,{throws:!1}),l=path_1.default.dirname(r);if(this.isNotHar(l,a))continue;this._allDependency.add(a.name),this._model.getAllModules().forEach((e=>{if(e.getProjectDir()===l){const t=new default_module_dependency_js_1.DefaultModuleDependency(e,s,r,a);o.set(e.getName(),t)}})),t.push(new default_npm_dependency_js_1.DefaultNpmDependency(s,l,r,a)),n.push(r)}}}}isValidHarByProfile(e){const o=path_1.default.resolve(e,"src","main",common_const_js_1.CommonConst.MODULE_JSON5),t=path_1.default.resolve(e,"src","main",common_const_js_1.CommonConst.MODULE_JSON),n=path_1.default.resolve(e,"src","main",common_const_js_1.CommonConst.CONFIG_JSON);return this.checkHarStatus(o,!1)||this.checkHarStatus(t,!1)||this.checkHarStatus(n,!0)}checkHarStatus(e,o){var t,n,r;if(!fs_extra_1.default.existsSync(e))return!1;const s=project_file_reader_js_1.ProjectFileReader.getJson5Obj(e),a=(null===(t=s.module)||void 0===t?void 0:t.type)===module_type_enum_js_1.ModuleType.Har||(null===(r=null===(n=s.module)||void 0===n?void 0:n.distro)||void 0===r?void 0:r.moduleType)===module_type_enum_js_1.ModuleType.Har,l=this._isFaMode?"FA model":"Stage model",d=this._isFaMode?"Stage model":"FA model";return a&&this._isFaMode!==o&&log._buildError(`${l} module ${this._moduleName} does not allow OpenHarmony npm packages \n      or modules in ${d}. OpenHarmony build tasks will not be executed, \n      and OpenHarmony resources will not be packed.`)._solution(solution)._file(e)._printErrorAndExit(this._moduleName),a}isNotHar(e,o){return!this.isValidHarByProfile(e)||!o.ohos||!o.name||this._allDependency.has(o.name)}}exports.DependencyManager=DependencyManager;