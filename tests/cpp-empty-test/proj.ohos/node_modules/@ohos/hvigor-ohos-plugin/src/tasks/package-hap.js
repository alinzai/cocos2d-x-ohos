"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,a){void 0===a&&(a=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,a,i)}:function(e,t,s,a){void 0===a&&(a=s),e[a]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackageHap=void 0;const fse=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),packing_tool_options_js_1=require("../builder/inner-java-command-builder/packing-tool-options.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),code_type_enum_js_1=require("../enum/code-type-enum.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),process_utils_js_1=require("../utils/process-utils.js"),build_native_with_ninja_js_1=require("./build-native-with-ninja.js"),task_names_js_1=require("./common/task-names.js"),compile_node_js_1=require("./compile-node.js"),make_pack_info_js_1=require("./make-pack-info.js"),process_libs_js_1=require("./process-libs.js"),syscap_transform_js_1=require("./syscap-transform.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js");var Task=task_names_js_1.TaskNames.Task;const lodash_1=require("lodash"),file_set_js_1=require("@ohos/hvigor-base/src/internal/snapshot/util/file-set.js"),fs_1=__importDefault(require("fs")),inject_util_js_1=require("../utils/inject-util.js");class PackageHap extends ohos_hap_task_js_1.OhosHapTask{constructor(e){super(e,Task.PACKAGE_HAP),this._log=ohos_logger_js_1.OhosLogger.getLogger(PackageHap.name),this.allPackInfoPath=[],this.allOutPath=[];const t=this.targetService.getTargetData().getPathInfo();this.packageToolPath=this.sdkInfo.getPackageTool(),this.libPath=t.getIntermediatesProcessLibs(),this.jsonPath=path_1.default.resolve(t.getIntermediatesRes(),common_const_js_1.CommonConst.MODULE_JSON),this.resourcePath=path_1.default.resolve(t.getIntermediatesRes(),build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES),this.indexPath=path_1.default.resolve(t.getIntermediatesRes(),build_directory_const_js_1.BuildArtifactConst.RESOURCE_INDEX),this.rpcidSc=path_1.default.resolve(t.getIntermediatesSysCap(),common_const_js_1.CommonConst.RPCID_SC),this.jsAssetsPath=path_1.default.resolve(t.getInterMediatesLoaderOutPath(),code_type_enum_js_1.CodeType.JS),this.etsAssetsPath=path_1.default.resolve(t.getInterMediatesLoaderOutPath(),code_type_enum_js_1.CodeType.ETS),this.nodeModulesPath=path_1.default.resolve(t.getInterMediatesLoaderOutPath(),common_const_js_1.CommonNodeConst.NODE_MODULES);const s=this.service.getRelatedEntryModules();if(s.length)for(const e of s)this.module.findModuleByName(e)&&(this.allPackInfoPath.push(path_1.default.resolve(t.getModuleBuildOutputPath(),e,build_directory_const_js_1.BuildArtifactConst.PACK_INFO)),this.allOutPath.push(path_1.default.resolve(t.getModuleBuildOutputPath(),this.targetService.getTargetData().getModuleTargetOutputFileName(e,!1))));else this.allPackInfoPath.push(path_1.default.resolve(t.getModuleBuildOutputPath(),build_directory_const_js_1.BuildArtifactConst.PACK_INFO)),this.allOutPath.push(path_1.default.resolve(t.getModuleBuildOutputPath(),this.targetService.getTargetData().getModuleTargetOutputFileName("",!1)))}declareExecutionTool(){return this.packageToolPath}declareExecutionCommand(){const e=[];for(let t=0;t<this.allPackInfoPath.length;t++)e.push(this.generateCommand(this.allPackInfoPath[t],this.allOutPath[t]).toString());return e.join()}declareInputFiles(){const e=(new file_set_js_1.FileSet).addEntries([this.libPath,this.jsonPath,this.resourcePath,this.indexPath,...this.allPackInfoPath],{isDirectory:!1});return fse.existsSync(this.rpcidSc)&&e.addEntry(this.rpcidSc,{isDirectory:!1}),fse.existsSync(this.jsAssetsPath)&&e.addEntry(this.jsAssetsPath,{isDirectory:!1}),fse.existsSync(this.etsAssetsPath)&&e.addEntry(this.etsAssetsPath,{isDirectory:!1}),fse.existsSync(this.nodeModulesPath)&&e.addEntry(this.nodeModulesPath,{isDirectory:!0}),e}declareOutputFiles(){return(new file_set_js_1.FileSet).addEntries([...this.allOutPath],{isDirectory:!1})}initTaskDepends(){var e;this.module.registryDependsOnTask(this,new make_pack_info_js_1.MakePackInfo(this.targetService),new process_libs_js_1.ProcessLibs(this.targetService),new build_native_with_ninja_js_1.BuildNativeWithNinja(this.targetService)),this.syscapJsonPath=path_1.default.resolve(null===(e=this.moduleModel)||void 0===e?void 0:e.getSourceRootByTargetName(this.targetName),common_const_js_1.CommonConst.SYSCAP_JSON),fs_1.default.existsSync(this.syscapJsonPath)&&this.module.registryDependsOnTask(this,new syscap_transform_js_1.SyscapTransform(this.targetService)),inject_util_js_1.InjectUtil.isHotReload()||this.module.registryDependsOnTask(this,new compile_node_js_1.CompileNode(this.targetService,code_type_enum_js_1.CodeType.ETS,task_names_js_1.TaskNames.Task.COMPILE_NODE),new compile_node_js_1.CompileNode(this.targetService,code_type_enum_js_1.CodeType.JS,task_names_js_1.TaskNames.Task.COMPILE_NODE))}declareInputs(){return(new Map).set("hotReload",inject_util_js_1.InjectUtil.isHotReload())}doTaskAction(e){for(let e=0;e<this.allPackInfoPath.length;e++)this.executeCommandList(this.allPackInfoPath[e],this.allOutPath[e])}executeCommandList(e,t){const s=this.generateCommand(e,t);this._log._printDebugCommand("PackageHap",s);const a={moduleName:this.moduleName,taskName:this.name,commandLine:s};new process_utils_js_1.ProcessUtils(a.moduleName,a.taskName).submitSyncExecutionWithoutReturn(this.getWorkerPool(),a,lodash_1.noop,[])}generateCommand(e,t){const s=new packing_tool_options_js_1.PackingToolOptions;return s.addCalledJarFile(this.packageToolPath),s.addMode("hap").force(!0).addLibPath(this.libPath).addJsonPath(this.jsonPath).addResourcesPath(this.resourcePath).addIndexPath(this.indexPath).addPackInfoPath(e).addOutPath(t),fse.existsSync(this.syscapJsonPath)&&fse.existsSync(this.rpcidSc)&&s.addSysCapPath(this.rpcidSc),fse.existsSync(this.jsAssetsPath)&&s.addJsPath(this.jsAssetsPath),fse.existsSync(this.etsAssetsPath)&&s.addEtsPath(this.etsAssetsPath),fse.existsSync(this.nodeModulesPath)&&s.addDirList([this.nodeModulesPath]),s.build()}}exports.PackageHap=PackageHap;