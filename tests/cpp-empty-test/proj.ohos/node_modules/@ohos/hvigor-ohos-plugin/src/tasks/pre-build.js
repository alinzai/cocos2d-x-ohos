"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PreBuild=void 0;const fs_1=__importDefault(require("fs")),os_1=__importDefault(require("os")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),module_type_enum_js_1=require("../enum/module-type-enum.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),validate_util_js_1=require("../utils/validate-util.js"),task_names_js_1=require("./common/task-names.js"),hvigor_base_1=require("@ohos/hvigor-base"),file_set_js_1=require("@ohos/hvigor-base/src/internal/snapshot/util/file-set.js"),abstract_pre_build_js_1=require("./abstract/abstract-pre-build.js"),project_file_reader_1=require("../utils/project-file-reader");var Task=task_names_js_1.TaskNames.Task;const _log=ohos_logger_js_1.OhosLogger.getLogger("hvigor-preBuild");class PreBuild extends abstract_pre_build_js_1.AbstractPreBuild{constructor(e){super(e,Task.PRE_BUILD),this.appJson5Path=this.projectModel.getAppRes().getJsonPath();const t=e.getTargetData().getModuleSourceSetModel().getModuleTargetRes();this.targetJsonPath=t.getJsonPath(),this.targetResourcesPath=t.getResourcePath(),this.targetModuleOptObj=t.getModuleJsonOpt(),this.formJsonPathArr=this.getFormJsonArr()}declareInputFiles(){var e;const t=(new file_set_js_1.FileSet).addEntries([this.appJson5Path,this.targetJsonPath,...this.formJsonPathArr],{isDirectory:!1});return fs_1.default.existsSync(path_1.default.resolve(null===(e=this.moduleModel)||void 0===e?void 0:e.getSourceRootByTargetName(this.targetName),common_const_js_1.CommonConst.SYSCAP_JSON))&&t.addEntry(this.syscapJsonPath),t}doValidateForDiffApiType(e){var t;this.appJson5Validate(),this.moduleJson5Validate(e),this.formJsonValidate(),this.validateHMServiceBundleName(),(null===(t=this.service.getModuleModel())||void 0===t?void 0:t.isHapModule())&&this.validateMainElementAndAbilities(),this.checkModuleType()}appJson5Validate(){const e=this.targetService.getSdkInfo().getAppSchema(),t=this.moduleModel.getModuleType()===module_type_enum_js_1.ModuleType.Har;validate_util_js_1.ValidateUtil.submitSchemaCheckWork(this.projectModel.getName(),this.appJson5Path,e,t)}moduleJson5Validate(e){const t=e.getTargetName(),o=this.targetService.getSdkInfo().getModuleSchema();validate_util_js_1.ValidateUtil.submitSchemaCheckWork(this.moduleName,this.targetJsonPath,o,!1),t!==common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&this.validateModuleName(this.moduleName,this.targetModuleOptObj.module.name,common_const_js_1.CommonConst.MODULE_JSON5);const i=(0,hvigor_base_1.parseJsonFile)(this.targetJsonPath,!0);if(i.module.uiSyntax){const e=i.module.uiSyntax._line,t=i.module.uiSyntax._column+1;_log._file(this.targetJsonPath).warn(`uiSyntax has been deprecated.${os_1.default.EOL}         at ${this.targetJsonPath}:${e}:${t}`)}void 0===i.module.uiSyntax&&this.sdkInfo.requireUISyntax()&&_log._buildError("The SDK version is outdated.")._solution("Open SDK Manager to update the ArkTS and JS components to the latest version.")._file(this.targetJsonPath)._printErrorAndExit(),validate_util_js_1.ValidateUtil.validateHybridDeviceTypes(i.module.deviceTypes)}formJsonValidate(){const e=this.sdkInfo.getFormSchema();this.formJsonPathArr.forEach((t=>{validate_util_js_1.ValidateUtil.submitSchemaCheckWork(this.moduleName,t,e,!1)}))}getFormJsonArr(){var e,t;const o=[];return(null===(e=this.targetModuleOptObj)||void 0===e?void 0:e.module.extensionAbilities)?(null===(t=this.targetModuleOptObj.module.extensionAbilities)||void 0===t||t.forEach((e=>{if(e.metadata&&"form"===e.type)for(const t of e.metadata)if(t.resource){const e=`${t.resource.replace(/\$profile:/,"")}.json`,i=path_1.default.resolve(this.targetResourcesPath,build_directory_const_js_1.BuildDirConst.BASE,build_directory_const_js_1.BuildDirConst.PROFILE,e);this.formJsonFileCheck(i,t,this.targetJsonPath),o.push(i)}})),o):o}formJsonFileCheck(e,t,o){if(!fs_1.default.existsSync(e)){const e=fs_1.default.readFileSync(o).toString().split("\n");let i=-1,s=-1;e.some(((e,o)=>-1!==(s=e.indexOf(t.resource))&&(i=o,!0))),_log.errorMessageExit(`Cannot resolve symbol '${t.resource}'${os_1.default.EOL}\t at ${o}:${i+1}:${s+1+t.resource.length}`)}}validateHMServiceBundleName(){var e;const t=/\.hmservice$/;if(null===(e=this.targetModuleOptObj)||void 0===e?void 0:e.module.installationFree){const e=this.service.getProjectModel(),o=e.getAppRes().getAppResOpt(),i=e.getAppRes().getJsonPath();if(!t.test(o.app.bundleName)){const e="Invalid value of bundleName in the app.json5 file.",t="If the current project is of an atomic service, the value of bundleName in the app.json5 file must end with '.hmservice'.";_log._buildError(e)._solution(t)._file(i)._printErrorAndExit()}}}validateMainElementAndAbilities(){if(void 0===this.targetModuleOptObj)return;const e=this.targetModuleOptObj.module.mainElement;if(this.targetModuleOptObj.module.installationFree&&void 0===e){const e="The 'mainElement' field not found in the module.json5 file.",t="If the current project is of an atomic service, make sure the 'mainElement' field is included.";_log._buildError(e)._solution(t)._file(this.targetJsonPath)._printErrorAndExit()}const t=this.targetModuleOptObj.module.abilities;null==t||t.forEach((t=>{if(void 0!==e&&t.name===e&&(void 0===t.label||void 0===t.icon)){const e="When the value of the mainElement field is the same as that of the name field, icon and label are required under ability.",t="Configuring the 'icon' and 'label' labels in the 'ability' field correctly";_log._buildError(e)._solution(t)._file(this.targetJsonPath)._printErrorAndExit()}}))}getJsonProfileByModel(){const e=project_file_reader_1.ProjectFileReader.getJson5Obj(this.targetJsonPath);return{jsonFilePath:this.targetJsonPath,profile:e,deviceTypes:e.module.deviceTypes,deviceConfig:common_const_js_1.CommonConst.DEVICETYPES,configurationProfile:common_const_js_1.CommonConst.MODULE_JSON5}}checkModuleType(){this.moduleType!==module_type_enum_js_1.ModuleType.Har||this.isESModule||_log._buildError("Invalid module type! Please check the package.json of current library module.")._file(this.moduleModel.getPackageJsonPath())._solution('Set \'{ "type": "module" }\'.')._printErrorAndExit()}}exports.PreBuild=PreBuild;