"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,a){void 0===a&&(a=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,a,i)}:function(e,t,s,a){void 0===a&&(a=s),e[a]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyPackageHap=void 0;const path_1=__importDefault(require("path")),packing_tool_options_js_1=require("../../builder/inner-java-command-builder/packing-tool-options.js"),common_const_js_1=require("../../const/common-const.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),process_utils_js_1=require("../../utils/process-utils.js"),ohos_hap_task_js_1=require("../task/ohos-hap-task.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),fse=__importStar(require("fs-extra")),legacy_make_pack_info_js_1=require("./legacy-make-pack-info.js"),process_libs_js_1=require("../process-libs.js"),task_names_js_1=require("../common/task-names.js"),build_native_with_ninja_js_1=require("../build-native-with-ninja.js"),sign_shell_js_1=require("../shell/sign-shell.js"),legacy_sign_lite_bin_js_1=require("./legacy-sign-lite-bin.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),lodash_1=require("lodash"),legacy_syscap_transform_js_1=require("./legacy-syscap-transform.js"),file_set_js_1=require("@ohos/hvigor-base/src/internal/snapshot/util/file-set.js"),fs_1=__importDefault(require("fs")),merge_node_assets_js_1=require("./merge-node-assets.js");var LegacyFATask=task_names_js_1.TaskNames.LegacyFATask;class LegacyPackageHap extends ohos_hap_task_js_1.OhosHapTask{constructor(e){super(e,LegacyFATask.PACKAGE_HAP),this._log=ohos_logger_js_1.OhosLogger.getLogger(LegacyPackageHap.name),this.allJsonPath=[],this.allResourcePath=[],this.allIndexPath=[],this.allPackInfoPath=[],this.allOutPath=[],this.allShellApkPath=[];const t=this.targetService.getTargetData(),s=t.getPathInfo();if(this.needPackBin=this.service.needPackBin(),this.packageTool=this.sdkInfo.getPackageTool(),this.binPath=path_1.default.resolve(s.getModuleBinOutput(),t.getModuleTargetOutputFileName("",null,build_directory_const_js_1.BuildArtifactExtension.DOT_BIN)),this.binOutPath=path_1.default.resolve(s.getModuleBuildOutputPath(),t.getModuleTargetOutputFileName("",!1)),this.libPath=path_1.default.resolve(s.getIntermediatesProcessLibs()),this.assetsPath=path_1.default.resolve(s.getIntermediatesFaAssetsPath()),this.rpcidSc=path_1.default.resolve(s.getIntermediatesSysCap(),common_const_js_1.CommonConst.RPCID_SC),this.dexPath=path_1.default.resolve(s.getIntermediatesDexDir(),"classes.dex"),this.apkPath=path_1.default.resolve(s.getIntermediatesApkDir(),t.getApkName()),this.hapBinCommand=this.getHapBinCommand(),this.moduleModel.getModuleType()===module_type_enum_js_1.ModuleType.Feature){for(const e of this.service.getRelatedEntryModules())if(this.module.findModuleByName(e)){this.allJsonPath.push(path_1.default.resolve(s.getIntermediatesRes(),e,common_const_js_1.CommonConst.CONFIG_JSON)),this.allResourcePath.push(path_1.default.resolve(s.getIntermediatesRes(),e,build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES)),this.allIndexPath.push(path_1.default.resolve(s.getIntermediatesRes(),e,build_directory_const_js_1.BuildArtifactConst.RESOURCE_INDEX)),this.allPackInfoPath.push(path_1.default.resolve(s.getModuleBuildOutputPath(),e,build_directory_const_js_1.BuildArtifactConst.PACK_INFO)),this.allOutPath.push(path_1.default.resolve(s.getModuleBuildOutputPath(),t.getModuleTargetOutputFileName(e,!1)));const a=t.findTargetDataByName(e);this.allShellApkPath.push(this.getShellApkPath(s.getIntermediatesApkDir(),a))}}else{this.allJsonPath.push(path_1.default.resolve(s.getIntermediatesRes(),"",common_const_js_1.CommonConst.CONFIG_JSON)),this.allResourcePath.push(path_1.default.resolve(s.getIntermediatesRes(),"",build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES)),this.allIndexPath.push(path_1.default.resolve(s.getIntermediatesRes(),"",build_directory_const_js_1.BuildArtifactConst.RESOURCE_INDEX)),this.allPackInfoPath.push(path_1.default.resolve(s.getModuleBuildOutputPath(),"",build_directory_const_js_1.BuildArtifactConst.PACK_INFO)),this.allOutPath.push(path_1.default.resolve(s.getModuleBuildOutputPath(),t.getModuleTargetOutputFileName("",!1)));const e=t.findTargetDataByName("");this.allShellApkPath.push(this.getShellApkPath(s.getIntermediatesApkDir(),e))}}declareExecutionTool(){return this.packageTool}declareExecutionCommand(){if(this.needPackBin)return this.hapBinCommand.toString();{const e=[];for(let t=0;t<this.allOutPath.length;t++)e.push(this.getHapCommand(this.allJsonPath[t],this.allResourcePath[t],this.allIndexPath[t],this.allPackInfoPath[t],this.allOutPath[t],this.allShellApkPath[t]).toString());return e.join()}}declareInputs(){return(new Map).set("needPackBin",this.needPackBin).set("needPackShell",this.needPackShell)}declareInputFiles(){if(this.needPackBin)return(new file_set_js_1.FileSet).addEntry(this.binPath,{isDirectory:!1});const e=(new file_set_js_1.FileSet).addEntries([this.libPath,this.assetsPath],{isDirectory:!1});if(e.addEntries([...this.allJsonPath,...this.allResourcePath,...this.allIndexPath,...this.allPackInfoPath],{isDirectory:!1}),fse.existsSync(this.rpcidSc)&&e.addEntry(this.rpcidSc,{isDirectory:!1}),this.needPackShell){e.addEntry(this.dexPath,{isDirectory:!1});for(const t of this.allShellApkPath)e.addEntries([...t],{isDirectory:!1})}return e}declareOutputFiles(){return this.needPackBin?(new file_set_js_1.FileSet).addEntry(this.binOutPath,{isDirectory:!1}):(new file_set_js_1.FileSet).addEntries([...this.allOutPath],{isDirectory:!1})}initTaskDepends(){var e;this.module.registryDependsOnTask(this,new legacy_make_pack_info_js_1.LegacyMakePackInfo(this.targetService),new process_libs_js_1.ProcessLibs(this.targetService),new merge_node_assets_js_1.MergeNodeAssets(this.targetService),new build_native_with_ninja_js_1.BuildNativeWithNinja(this.targetService)),this.syscapJsonPath=path_1.default.resolve(null===(e=this.moduleModel)||void 0===e?void 0:e.getSourceRootByTargetName(this.targetName),common_const_js_1.CommonConst.SYSCAP_JSON),fs_1.default.existsSync(this.syscapJsonPath)&&this.module.registryDependsOnTask(this,new legacy_syscap_transform_js_1.LegacySyscapTransform(this.targetService)),this.needPackShell&&this.module.registryDependsOnTask(this,new sign_shell_js_1.SignShell(this.targetService)),this.service.hasLiteDevice()&&this.module.registryDependsOnTask(this,new legacy_sign_lite_bin_js_1.LegacySignLiteBin(this.targetService))}doTaskAction(e){this.needPackBin?this.buildHapBinBuilder():this.buildHapBuilder()}buildHapBuilder(){for(let e=0;e<this.allOutPath.length;e++)this.buildHapPackageOptions(this.allJsonPath[e],this.allResourcePath[e],this.allIndexPath[e],this.allPackInfoPath[e],this.allOutPath[e],this.allShellApkPath[e])}buildHapPackageOptions(e,t,s,a,i,l){this.executeCommandList(this.getHapCommand(e,t,s,a,i,l))}buildHapBinBuilder(){this.executeCommandList(this.hapBinCommand)}getHapCommand(e,t,s,a,i,l){const o=new packing_tool_options_js_1.PackingToolOptions;return o.addCalledJarFile(this.packageTool),o.addMode("hap").force(!0).addLibPath(this.libPath).addJsonPath(e).addResourcesPath(t).addAssetsPath(this.assetsPath).addIndexPath(s).addPackInfoPath(a).addOutPath(i),this.needPackShell&&o.addDexPath(this.dexPath).addShellApkPath(l),fse.existsSync(this.syscapJsonPath)&&fse.existsSync(this.rpcidSc)&&o.addSysCapPath(this.rpcidSc),o.build()}getHapBinCommand(){const e=new packing_tool_options_js_1.PackingToolOptions;return e.addCalledJarFile(this.packageTool),e.addMode("hap").addBinPath(this.binPath).addOutPath(this.binOutPath).force(!0),e.build()}executeCommandList(e){this._log._printDebugCommand("PackageHap",e);const t={moduleName:this.moduleName,taskName:this.name,commandLine:e};new process_utils_js_1.ProcessUtils(this.moduleName,this.name).submitSyncExecutionWithoutReturn(this.getWorkerPool(),t,lodash_1.noop,[])}getShellApkPath(e,t){const s=[];return this.needPackShell&&(s.push(this.apkPath),t&&"ohosTest"!==this.targetName&&s.push(path_1.default.resolve(e,t.getApkName(!0)))),s}}exports.LegacyPackageHap=LegacyPackageHap;