"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractSyscapTransform=void 0;const ohos_hap_task_js_1=require("../task/ohos-hap-task.js"),path_1=__importDefault(require("path")),common_const_js_1=require("../../const/common-const.js"),fs_1=__importDefault(require("fs")),project_file_reader_js_1=require("../../utils/project-file-reader.js"),lodash_1=require("lodash"),file_util_js_1=require("../../utils/file-util.js"),process_utils_js_1=require("../../utils/process-utils.js"),file_set_js_1=require("@ohos/hvigor-base/src/internal/snapshot/util/file-set.js"),fs_extra_1=__importDefault(require("fs-extra")),pre_check_syscap_js_1=require("../pre-check-syscap.js"),task_names_js_1=require("../common/task-names.js");var CommonTask=task_names_js_1.TaskNames.CommonTask;const validate_util_js_1=require("../../utils/validate-util.js");class AbstractSyscapTransform extends ohos_hap_task_js_1.OhosHapTask{constructor(e,s){var t;super(e,s);const o=e.getTargetData().getTargetName();this.hapExtraInfo=this.service.getHapExtraInfo(),this.sourceRoot=null===(t=this.service.getModuleModel())||void 0===t?void 0:t.getSourceRootByTargetName(o),this.pathInfo=this.targetService.getTargetData().getPathInfo(),this.syscapJsonPath=path_1.default.resolve(this.sourceRoot,common_const_js_1.CommonConst.SYSCAP_JSON);const a=this.sdkInfo;this.syscapTool=a.getSysCapTool(),this.requireSyscapPath=fs_1.default.existsSync(a.getSdkJsDir())&&!fs_1.default.existsSync(a.getSdkEtsDir())?a.getSysCapFileInJs():a.getSysCapFileInEts(),this.rpcidScPath=path_1.default.resolve(this.pathInfo.getIntermediatesSysCap(),common_const_js_1.CommonConst.RPCID_SC)}declareInputFiles(){const e=(new file_set_js_1.FileSet).addEntry(this.syscapTool).addEntry(this.requireSyscapPath);return fs_1.default.existsSync(path_1.default.resolve(this.sourceRoot,common_const_js_1.CommonConst.SYSCAP_JSON))&&e.addEntry(this.syscapJsonPath),e}declareOutputFiles(){return(new file_set_js_1.FileSet).addEntry(this.rpcidScPath)}initTaskDepends(){this.node.registryDependsOnTask(this,new pre_check_syscap_js_1.PreCheckSyscap(this.targetService,CommonTask.PRE_CHECK_SYSCAP))}doTaskAction(e){var s;const t=/^SystemCapability(\.[a-zA-Z0-9]+){2,3}$/,o=this.getJsonProfileByModel(),a=project_file_reader_js_1.ProjectFileReader.getJson5Obj(this.syscapJsonPath),i=a.devices,r=i.general,n=i.custom,c=new Set,_=[];let l=new Set;if(0===o.deviceTypes.length)l=this.intersectNDeviceSysCap(n,_,t,this.syscapJsonPath);else if(r.forEach((e=>{this.getRequireSysCapList(this.requireSyscapPath,e,c)})),void 0!==n){this.intersectNDeviceSysCap(n,_,t,this.syscapJsonPath).forEach((e=>{c.has(e)&&l.add(e)}))}if(this.moduleModel.isHarModule())return;if(this.addOrRemoveSyscapByProduction(a,t,l,common_const_js_1.CommonConst.ADDED_SYSCAPS),this.addOrRemoveSyscapByProduction(a,t,l,common_const_js_1.CommonConst.REMOVED_SYSCAPS),0===l.size)return;const h=new Map,d=null===(s=this.service.getModuleModel())||void 0===s?void 0:s.getCompileApiVersion();h.set("api_version",d),h.set("syscap",Array.from(l));const u=this.pathInfo.getIntermediatesSysCap();file_util_js_1.FileUtil.checkDirWithoutDelete(u);const p=path_1.default.resolve(u,common_const_js_1.CommonConst.RPCID_JSON);fs_extra_1.default.outputJsonSync(p,Object.fromEntries(h));const m={moduleName:this.moduleName,taskName:this.name,commandLine:[this.syscapTool,"-R","-e","-i",p,"-o",u]};new process_utils_js_1.ProcessUtils(m.moduleName,m.taskName).submitSyncExecutionWithoutReturn(this.getWorkerPool(),m,lodash_1.noop,[])}getRequireSysCapList(e,s,t){fs_1.default.readdirSync(e).forEach((o=>{if(o.toString().slice(0,o.toString().indexOf("."))===s){project_file_reader_js_1.ProjectFileReader.getJson5Obj(path_1.default.resolve(e,o.toString())).SysCaps.forEach((e=>{t.add(e)}))}}))}intersectNDeviceSysCap(e,s,t,o){if(void 0!==e){e.forEach((e=>{Object.keys(e).forEach((t=>{s.push(e[t])}))}));for(let e=0;e<s.length;e++)for(let a=0;a<s[e].length;a++)validate_util_js_1.ValidateUtil.fieldRegExpCheck(s[e][a],"custom",t,o)}return new Set((0,lodash_1.intersection)(...s))}addOrRemoveSyscapByProduction(e,s,t,o){const a=e.production;void 0!==a&&void 0!==a[o]&&0!==a[o].length&&a[o].forEach((e=>{switch(o){case common_const_js_1.CommonConst.ADDED_SYSCAPS:t.add(e);break;case common_const_js_1.CommonConst.REMOVED_SYSCAPS:t.delete(e)}}))}}exports.AbstractSyscapTransform=AbstractSyscapTransform;