"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProjectTaskService=void 0;const sdkmanager_common_1=require("@ohos/sdkmanager-common"),path_1=__importDefault(require("path")),util_1=__importDefault(require("util")),find_target_product_js_1=require("../../common/find-target-product.js"),project_path_info_iml_js_1=require("../../common/iml/project-path-info-iml.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),runtime_type_enum_js_1=require("../../enum/runtime-type-enum.js"),default_plugin_id_js_1=require("../../plugin/common/default-plugin-id.js"),hap_plugin_js_1=require("../../plugin/hap-plugin.js"),project_extra_info_service_js_1=require("../../project/project-extra-info-service.js"),sdk_info_js_1=require("../../sdk/sdk-info.js"),array_util_js_1=require("../../utils/array-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),task_service_js_1=require("./task-service.js");class ProjectTaskService extends task_service_js_1.TaskService{constructor(e,t,r,o){super(e,t,r,o),this._log=ohos_logger_js_1.OhosLogger.getLogger(ProjectTaskService.name),this.initProductData=()=>{const e=this.hvigorNode;null==e||e.getSubModules().forEach((e=>{var t;const r=e.getName(),o=e.getPluginById(default_plugin_id_js_1.DefaultPluginId.OHOS_HAP_PLUGIN),i=[];if(void 0!==o&&o instanceof hap_plugin_js_1.HapPlugin){const e=null===(t=this._projectModel)||void 0===t?void 0:t.getModuleProfileOpt(r),s=null==e?void 0:e.targets,_=o.getTaskService().getTargetDataSet(),n=new Set;_.forEach((e=>{e[1]&&void 0!==(0,array_util_js_1.getElementFromArr)(s,e[0].getTargetName())&&i.push(e[0]),n.add(e[0].getTargetName())})),this.checkTargets(n,s),0!==i.length&&this._productDataMap.set(r,i)}}))},this._targetProduct=(0,find_target_product_js_1.findTargetProduct)(t),this._moduleDependencyInfo=r;const i=project_extra_info_service_js_1.ProjectExtraInfoService.getProjectRuntimeOS(t)===runtime_type_enum_js_1.RuntimeTypeEnum.OpenHarmony;this._sdkInfo=new sdk_info_js_1.SdkInfo(t.getCompileApiVersion(),[sdkmanager_common_1.ComponentPath.TOOLCHAINS],i),this._pathInfo=new project_path_info_iml_js_1.ProjectPathInfoIml(t,this._targetProduct.name),this._productDataMap=new Map,this.initProductData()}getSdkInfo(){return this._sdkInfo}getProductDataMap(){return this._productDataMap}getPathInfo(){return this._pathInfo}getTargetProduct(){return this._targetProduct}getAppOutputFileName(e=!1){const t=e?"signed":"unsigned";return`${this._projectModel.getName()}-${this._targetProduct.name}-${t}${build_directory_const_js_1.BuildArtifactExtension.DOT_APP}`}checkTargets(e,t){var r;if(t)for(const o of t)e.has(o.name)||this._log._buildError(`Unknown target '${o.name}'.`)._solution(`Check the value of name under the targets tag of the module: ${util_1.default.format(o)}.`)._file(path_1.default.resolve(null===(r=this._projectModel)||void 0===r?void 0:r.getProjectDir(),common_const_js_1.CommonConst.PROFILE_JSON5))._printErrorAndExit()}}exports.ProjectTaskService=ProjectTaskService;