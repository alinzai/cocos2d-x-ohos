"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MakePackInfo=void 0;const ohos_logger_js_1=require("../utils/log/ohos-logger.js"),task_names_js_1=require("./common/task-names.js"),merge_profile_js_1=require("./merge-profile.js");var Task=task_names_js_1.TaskNames.Task;const abstract_make_pack_info_js_1=require("./abstract-make-pack-info.js"),file_set_js_1=require("@ohos/hvigor-base/src/internal/snapshot/util/file-set.js");class MakePackInfo extends abstract_make_pack_info_js_1.AbstractMakePackInfo{constructor(e){super(e,Task.MAKE_PACK_INFO),this.log=ohos_logger_js_1.OhosLogger.getLogger(MakePackInfo.name)}declareInputFiles(){const e=this.projectModel.getAppRes().getJsonPath(),t=this.targetService.getTargetData().getModuleSourceSetModel().getModuleTargetRes().getJsonPath();return(new file_set_js_1.FileSet).addEntry(e).addEntry(t)}initTaskDepends(){this.module.registryDependsOnTask(this,new merge_profile_js_1.MergeProfile(this.targetService))}doTaskAction(e){const t=this.service.getModuleModel(),s=this.service.getProjectModel(),o=s.getAppRes().getAppResOpt(),i=e.getProduct().bundleName,a={code:o.app.versionCode,name:o.app.versionName,minCompatibleVersionCode:o.app.minCompatibleVersionCode},r={bundleName:null!=i?i:o.app.bundleName,version:a};this.doMakePackInfo(this.log,s,t,r)}processExtensionAbilities(e,t,s){if(void 0===e)return;const o=[];for(const i of e){const e={name:i.name,forms:this.processForms(MakePackInfo.processMetaData(i.metadata,t,s))};o.push(e)}return o}static processMetaData(e,t,s){if(void 0===e)return;const o=[];for(const i of e){const e=MakePackInfo.processResourcePath(i.resource);if(i.name&&i.name.indexOf("form")>=0&&void 0!==e){const i=t.getFormJsonObjByTargetName(s,e).forms;for(let e=0;e<i.length;e++)o.push(i[e])}}return o}static processResourcePath(e){if(!e)return;const t=e.split(":");return 2!==t.length||"$"!==t[0].charAt(0)||t[0].length<2?void 0:`base/${t[0].substring(1)}/${t[1]}.json`}getModuleObj(e,t,s,o){const i=t.getJsonObjByTargetName(o),a={moduleType:i.module.type,installationFree:i.module.installationFree,deliveryWithInstall:i.module.deliveryWithInstall,moduleName:i.module.name},r={compatible:this.service.getProjectModel().getCompatibleApiVersion(),releaseType:this.sdkInfo.getReleaseType(),target:this.service.getProjectModel().getCompileApiVersion()};return{mainAbility:i.module.mainElement,deviceType:e,abilities:this.processAbilities(i.module.abilities),extensionAbilities:this.processExtensionAbilities(i.module.extensionAbilities,t,o),distro:a,apiVersion:r}}getPackageObj(e,t,s){return{deviceType:e.getTargetDeviceType(),moduleType:t.module.type,deliveryWithInstall:t.module.deliveryWithInstall,name:s}}}exports.MakePackInfo=MakePackInfo;