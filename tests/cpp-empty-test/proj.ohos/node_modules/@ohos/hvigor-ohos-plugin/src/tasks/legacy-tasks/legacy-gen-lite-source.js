"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyGenLiteSource=void 0;const ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),ohos_hap_task_js_1=require("../task/ohos-hap-task.js"),legacy_compile_lite_node_js_1=require("./legacy-compile-lite-node.js"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),packing_tool_options_js_1=require("../../builder/inner-java-command-builder/packing-tool-options.js"),process_utils_js_1=require("../../utils/process-utils.js"),file_util_js_1=require("../../utils/file-util.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),task_names_js_1=require("../common/task-names.js"),lodash_1=require("lodash");class LegacyGenLiteSource extends ohos_hap_task_js_1.OhosHapTask{constructor(e){super(e,task_names_js_1.TaskNames.LegacyFATask.GENERATE_LITE_CODE),this._logger=ohos_logger_js_1.OhosLogger.getLogger(LegacyGenLiteSource.name)}taskShouldDo(e){return this.service.needPackBin()}initTaskDepends(){this.module.registryDependsOnTask(this,new legacy_compile_lite_node_js_1.LegacyCompileLiteNode(this.targetService))}doTaskAction(e){const t=e.getPathInfo(),s=path_1.default.resolve(t.getIntermediatesLiteSource(),"assets");fs_extra_1.default.copySync(t.getIntermediatesFaAssetsPath(),s);const o=path_1.default.resolve(t.getIntermediatesRes(),"config.json"),i=path_1.default.resolve(t.getIntermediatesLiteSource(),"config.json");fs_extra_1.default.copyFileSync(o,i);const r=path_1.default.resolve(t.getIntermediatesRes(),build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES),a=path_1.default.resolve(s,this.module.getName(),build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES);fs_extra_1.default.copySync(r,a),fs_extra_1.default.copySync(t.getIntermediatesLiteBinSource(),a);const _=path_1.default.resolve(t.getIntermediatesRes(),"resources.index"),l=path_1.default.resolve(s,this.module.getName(),"resources.index");fs_extra_1.default.copyFileSync(_,l);const u=new packing_tool_options_js_1.PackingToolOptions;u.addCalledJarFile(this.sdkInfo.getHapTobin()),u.addProjectPath(t.getIntermediatesLiteSource()).addBinPath(path_1.default.resolve(t.getModuleBinOutput(),e.getModuleTargetOutputFileName("",null,build_directory_const_js_1.BuildArtifactExtension.DOT_BIN))),this._logger.debug(u.build()),file_util_js_1.FileUtil.checkDirWithoutDelete(t.getModuleBinOutput());const n={moduleName:this.moduleName,commandLine:u.build()};new process_utils_js_1.ProcessUtils(n.moduleName).submitSyncExecutionWithoutReturn(this.getWorkerPool(),n,lodash_1.noop,[])}beforeTask(e){fs_extra_1.default.emptyDirSync(e.getPathInfo().getIntermediatesLiteSource())}}exports.LegacyGenLiteSource=LegacyGenLiteSource;