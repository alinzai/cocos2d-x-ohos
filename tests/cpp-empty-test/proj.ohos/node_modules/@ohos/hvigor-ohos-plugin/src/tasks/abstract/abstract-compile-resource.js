"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractCompileResource=void 0;const compile_resources_util_js_1=require("../../utils/compile-resources-util.js"),map_util_js_1=require("../../utils/map-util.js"),ohos_hap_task_js_1=require("../task/ohos-hap-task.js"),process_utils_js_1=require("../../utils/process-utils.js"),file_util_js_1=require("../../utils/file-util.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),project_file_reader_js_1=require("../../utils/project-file-reader.js"),inject_const_js_1=require("../../const/inject-const.js"),hvigor_base_1=require("@ohos/hvigor-base"),lodash_1=require("lodash"),path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra"));class AbstractCompileResource extends ohos_hap_task_js_1.OhosHapTask{constructor(e,t){super(e,t),this.compileCommands=[],this.linkCommand=[],this.intermediatesResDir=this.pathInfo.getIntermediatesRes(),this.isPreview=hvigor_base_1.hvigor.getExtraConfig().get(inject_const_js_1.InjectConst.BUILD_ROOT)===build_directory_const_js_1.BuildDirConst.PREVIEW_BUILD_PATH}beforeTask(e){file_util_js_1.FileUtil.checkDirWithoutDelete(this.intermediatesResDir),file_util_js_1.FileUtil.checkDirWithoutDelete(this.generateSourceRDir)}declareInputs(){const e=new Map;return this.isPreview&&(e.set("PREVIEWER_REPLACE_PAGE",JSON.stringify(hvigor_base_1.hvigor.getExtraConfig().get(inject_const_js_1.InjectConst.PREVIEWER_REPLACE_PAGE))),e.set("PREVIEWER_REPLACE_SRCPATH",JSON.stringify(hvigor_base_1.hvigor.getExtraConfig().get(inject_const_js_1.InjectConst.PREVIEWER_REPLACE_SRC_PATH)))),e.set("TARGET_CONFIG",JSON.stringify(this.targetData.getTargetOpt())),e}declareExecutionTool(){return this.getResToolFile()}declareInputFiles(){return this.processResourceTask.getCompileResourceInputFiles()}declareOutputFiles(){return this.processResourceTask.getCompileResourceOutputFiles().addEntries([this.intermediatesResDir,this.generateSourceRDir],{isDirectory:!0})}getResToolFile(){return this.sdkInfo.getRestool()}executeCommandSync(e,t,s=lodash_1.noop){t._printDebugCommand("restool",e);const i=this.getInputData(e);new process_utils_js_1.ProcessUtils(i.moduleName,i.taskName).submitSyncExecutionWithoutReturn(this.getWorkerPool(),i,s,[])}compileLink(e,t=lodash_1.noop){let s=0;this.compileCommands.map((i=>this.executeCommandSync(i,e,(()=>{s++,s===this.compileCommands.length&&this.executeCommandSync(this.linkCommand,e,t)}))))}getInputData(e){return{moduleName:this.moduleName,taskName:this.name,commandLine:e}}previewCompileLink(e,t=lodash_1.noop){this.restoolLinkParamObj=this.processResourceTask.restoolCommandBuilder.restoolLinkParamObj,this.buildIncrementalCompileLinkFullCommand(),this.compileLink(e,t),this.previewBuildParamPersistence()}previewBuildParamPersistence(){const e=this.restoolLinkParamObj.appScopeResources,t=this.restoolLinkParamObj.moduleResourcesMap,s=this.restoolLinkParamObj.harResourcesMap,i={APP_RESOURCES:e||"",MODULE_RESOURCES:JSON.stringify((0,map_util_js_1.strMapToObj)(t)),HAR_RESOURCES:JSON.stringify((0,map_util_js_1.strMapToObj)(s)),PREVIEW_GENERATE_SOURCE_DIR:this.pathInfo.getPreviewGenerateSourceR(),PREVIEW_COMPILE_MODULE_NAMES:compile_resources_util_js_1.CompileResourcesUtil.getRestoolModuleNames(this.service,this.targetName).join(",")},o=path_1.default.resolve(this.pathInfo.getModulePreviewPath(),build_directory_const_js_1.BuildArtifactConst.PREVIEW_BUILD_PARAM_JSON);fs_extra_1.default.outputJSONSync(o,i)}buildIncrementalCompileLinkFullCommand(){var e;this.linkCommand=this.restoolLinkParamObj.linkCommand,this.linkOutputPath=null===(e=this.restoolLinkParamObj)||void 0===e?void 0:e.outputPath;const t=this.restoolLinkParamObj.appScopeResources,s=this.restoolLinkParamObj.moduleResourcesMap,i=this.restoolLinkParamObj.harResourcesMap,o=this.restoolLinkParamObj.outputPath;if(fs_extra_1.default.existsSync(this.restoolLinkParamObj.outputPath)&&fs_extra_1.default.rmSync(this.restoolLinkParamObj.outputPath,{recursive:!0}),t&&t.length>0){const e=path_1.default.resolve(this.linkOutputPath,build_directory_const_js_1.BuildDirConst.APP_COMPILED),s=[this.getResToolFile(),"-x",t,"-o",e];this.compileCommands.push(s),this.linkCommand.push("-i",e),fs_extra_1.default.existsSync(e)||fs_extra_1.default.mkdirsSync(e)}this.linkCommandPushResourcesMap(s),this.linkCommandPushResourcesMap(i),this.linkCommand.push("-o",o)}linkCommandPushResourcesMap(e){e.size>0&&e.forEach(((e,t)=>{const s=path_1.default.resolve(this.linkOutputPath,e),i=[this.getResToolFile(),"-x",t,"-o",s];this.compileCommands.push(i),this.linkCommand.push("-i",s),fs_extra_1.default.existsSync(s)||fs_extra_1.default.mkdirsSync(s)}))}retainDeviceType(e,t,s){const i=e.findTargetDataByName(t);if(i){const o=i.getTargetDeviceType(),r=e.getTargetDeviceType().filter((e=>(null==o?void 0:o.indexOf(e))>-1)),a=path_1.default.resolve(e.getPathInfo().getIntermediatesRes(),t,common_const_js_1.CommonConst.CONFIG_JSON),n=project_file_reader_js_1.ProjectFileReader.getJson5Obj(a);n.module.deviceType=r,fs_extra_1.default.outputJsonSync(a,n,{spaces:"\t"}),0===r.length&&s.warn(`The device types of ${this.moduleModel.getName()} and ${t} are different. Invalid HAP ${this.moduleModel.getName()}.`)}else s._buildError(`Unable to find '${e.getTargetName()}' in module ${t}. Make sure module ${this.moduleName} has the same target as ${t}.`)._printErrorAndExit(this.moduleName)}replaceTargetPages(e,t){var s;const i=null===(s=e.getTargetOpt().source)||void 0===s?void 0:s.pages;void 0!==i&&this.replacePages(t,i)}}exports.AbstractCompileResource=AbstractCompileResource;