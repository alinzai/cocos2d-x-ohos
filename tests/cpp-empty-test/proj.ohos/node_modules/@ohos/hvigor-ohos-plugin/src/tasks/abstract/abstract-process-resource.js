"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractProcessResource=void 0;const ohos_hap_task_js_1=require("../task/ohos-hap-task.js"),restool_file_config_builder_js_1=require("../../builder/restool-file-config-builder.js"),file_set_js_1=require("@ohos/hvigor-base/src/internal/snapshot/util/file-set.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),restool_command_builder_js_1=require("../../builder/restool-command-builder.js"),compile_resources_util_js_1=require("../../utils/compile-resources-util.js"),validate_util_js_1=require("../../utils/validate-util.js"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),lodash_1=require("lodash");class AbstractProcessResource extends ohos_hap_task_js_1.OhosHapTask{constructor(e,t){super(e,t),this.needInitCommandBuilder=!0,this.restoolConfigBuilder=this.getRestoolConfigBuilder()}doTaskAction(e){const t=this.restoolConfigBuilder.getConfigObject();fs_extra_1.default.outputJSONSync(this.resConfigFilePath,t)}getCompileResourceInputFiles(){return this.restoolConfigBuilder.inputFiles}getCompileResourceOutputFiles(){return this.restoolConfigBuilder.outputFiles}declareInputs(){return this.needInitCommandBuilder&&(this.initCommandBuilder(),this.needInitCommandBuilder=!1),(new Map).set("resConfigJsonContent",JSON.stringify(this.restoolConfigBuilder.getConfigObject()))}declareOutputFiles(){return(new file_set_js_1.FileSet).addEntry(this.resConfigFilePath,{isDirectory:!1})}getRestoolModules(){const e=new Set([this.moduleName,...this.projectModel.getSubProjects().keys()]);return this.isFaMode?e.add(this.moduleModel.getSourceSetByTargetName(this.targetName).getLegacyModuleTargetRes().getConfigJsonOpt().module.distro.moduleName):e.add(this.moduleModel.getSourceSetByTargetName(this.targetName).getModuleTargetRes().getModuleJsonOpt().module.name),[...e]}getRestoolConfigBuilder(){const e=this.initConfigTargetResource();e.addModules(compile_resources_util_js_1.CompileResourcesUtil.getRestoolModuleNames(this.service,this.targetName).join(",")).forceDelete();return this.service.getDependencyRootPaths().forEach((t=>{e.addInputDir(path_1.default.resolve(t,"src","main",build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES),"Har")})),e}initConfigTargetResource(){var e;const t=new restool_file_config_builder_js_1.RestoolConfigBuilder,o=null===(e=this.targetData.getTargetOpt().resource)||void 0===e?void 0:e.directories;return void 0===o?t.addInputDir(path_1.default.resolve(this.moduleModel.getSourceSetByTargetName(this.targetData.getTargetName()).getSourceSetRoot(),build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES),"Module"):this.convertResourceAbsolutePath(o,(e=>{t.addInputDir(e,"Module")})),t}convertResourceAbsolutePath(e,t=lodash_1.noop){e.forEach(((e,o)=>{const s=path_1.default.isAbsolute(e)?e:path_1.default.resolve(this.moduleModel.getProjectDir(),e);validate_util_js_1.ValidateUtil.validateTargetCustomizeResources(e,s),t(s,o)}))}getRestoolCommandBuilder(){const e=this.initCommandTargetResource();return e.addModules(compile_resources_util_js_1.CompileResourcesUtil.getRestoolModuleNames(this.service,this.targetName).join(",")).forceDelete(),e}initCommandTargetResource(){var e;const t=this.service.getModuleModel(),o=new restool_command_builder_js_1.RestoolCommandBuilder(this.sdkInfo.getRestool()),s=null===(e=this.targetData.getTargetOpt().resource)||void 0===e?void 0:e.directories,r=new Map,i=new Map;if(void 0===s){const e=path_1.default.resolve(t.getSourceSetByTargetName(this.targetData.getTargetName()).getSourceSetRoot(),build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES),o=0,s=compile_resources_util_js_1.CompileResourcesUtil.getCompileTargetFolderBySeq(build_directory_const_js_1.BuildDirConst.MODULE_COMPILED,o);r.set(e,s)}else this.convertResourceAbsolutePath(s,((e,t)=>{const o=compile_resources_util_js_1.CompileResourcesUtil.getCompileTargetFolderBySeq(build_directory_const_js_1.BuildDirConst.MODULE_COMPILED,t);r.set(e,o)}));return this.service.getNpmDependencies().forEach(((e,t)=>{const o=path_1.default.resolve(e.getDependencyRootPath(),"src","main",build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES),s=compile_resources_util_js_1.CompileResourcesUtil.getCompileTargetFolderBySeq(build_directory_const_js_1.BuildDirConst.HAR_COMPILED,t);i.set(o,s)})),o.addModuleResourcesMap(r),o.addHarResourcesMap(i),o}}exports.AbstractProcessResource=AbstractProcessResource;