"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackageApp=void 0;const path_1=__importDefault(require("path")),packing_tool_options_js_1=require("../builder/inner-java-command-builder/packing-tool-options.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),file_util_js_1=require("../utils/file-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),process_utils_js_1=require("../utils/process-utils.js"),task_names_js_1=require("./common/task-names.js"),make_project_pack_info_js_1=require("./make-project-pack-info.js"),pre_build_app_js_1=require("./pre-build-app.js"),ohos_app_task_js_1=require("./task/ohos-app-task.js");var Task=task_names_js_1.TaskNames.Task;const fs_extra_1=__importDefault(require("fs-extra")),file_set_js_1=require("@ohos/hvigor-base/src/internal/snapshot/util/file-set.js");class PackageApp extends ohos_app_task_js_1.OhosAppTask{constructor(t,e){super(t,e,Task.PACKAGE_APP),this._log=ohos_logger_js_1.OhosLogger.getLogger(PackageApp.name),this.allDestDir=[],this.allSrcHapPath=[],this.allDestHapPath=[],this.packageTool=this.service.getSdkInfo().getPackageTool();const s=this.service.getPathInfo();this.packInfoPath=path_1.default.resolve(s.getProjectOutputPath(),build_directory_const_js_1.BuildArtifactConst.PACK_INFO),this.packResPath=path_1.default.resolve(s.getProjectOutputPath(),build_directory_const_js_1.BuildArtifactConst.PACK_RES),this.entryCardDir=path_1.default.resolve(this.project.getNodeDir(),"EntryCard"),this.outPath=path_1.default.resolve(s.getProjectOutputPath(),this.service.getAppOutputFileName()),this.service.getProductDataMap().forEach((t=>{for(const e of t){const t=e.getPathInfo().getModuleBuildOutputPath(),s=e.getModuleTargetOutputFileName("",!1),a=path_1.default.resolve(t,s),i=path_1.default.resolve(t,"app");this.allDestDir.push(i);const r=e.getRelatedEntryModules();if(r.length)for(const s of r){const a=e.getModuleTargetOutputFileName(s,!1),r=path_1.default.resolve(t,a),o=path_1.default.resolve(i,a.replace("-unsigned",""));this.allSrcHapPath.push(r),this.allDestHapPath.push(o)}else{const t=path_1.default.resolve(i,s.replace("-unsigned",""));this.allSrcHapPath.push(a),this.allDestHapPath.push(t)}}})),this.needPackRes=fs_extra_1.default.existsSync(this.entryCardDir)&&fs_extra_1.default.statSync(this.entryCardDir).isDirectory(),this.needPackRes&&(this.packResCommand=(new packing_tool_options_js_1.PackingToolOptions).addCalledJarFile(this.packageTool).addMode("res").addEntryCardPath(this.entryCardDir).addPackInfoPath(this.packInfoPath).addOutPath(this.packResPath).force(!0).build())}declareExecutionTool(){return this.packageTool}declareExecutionCommand(){var t;return`${this.getPackAppCommand().toString()}${null===(t=this.packResCommand)||void 0===t?void 0:t.toString()}`}declareInputs(){return(new Map).set("needPackRes",this.needPackRes).set("allDestDir",this.allDestDir)}declareInputFiles(){const t=(new file_set_js_1.FileSet).addEntries([this.packInfoPath,...this.allSrcHapPath],{isDirectory:!1});return this.needPackRes&&t.addEntry(this.entryCardDir,{isDirectory:!0}),t}declareOutputFiles(){const t=(new file_set_js_1.FileSet).addEntries([this.outPath,...this.allDestHapPath],{isDirectory:!1});return this.needPackRes&&t.addEntry(this.packResPath,{isDirectory:!1}),t}initTaskDepends(){this.project.registryDependsOnTask(this,new pre_build_app_js_1.PreBuildApp(this.project,this.service)),this.project.registryDependsOnTask(this,new make_project_pack_info_js_1.MakeProjectPackInfo(this.project,this.service))}doTaskAction(){this.packRes(),this.getUnpackedHaps();const t=this.getPackAppCommand();this._log._printDebugCommand("PackageApp",t),(new process_utils_js_1.ProcessUtils).executeSync(t)}getPackAppCommand(){const t=new packing_tool_options_js_1.PackingToolOptions;return t.addCalledJarFile(this.packageTool),fs_extra_1.default.existsSync(this.packResPath)&&t.addPackResPath(this.packResPath),t.addMode("app").addPackInfoPath(this.packInfoPath).addHapPath(this.allDestHapPath.join(",")).force(!0).addOutPath(this.outPath),t.build()}getUnpackedHaps(){for(const t of this.allDestDir)file_util_js_1.FileUtil.checkDirWithoutDelete(t);for(let t=0;t<this.allSrcHapPath.length;t++)PackageApp.writeFile(this.allDestHapPath[t],this.allSrcHapPath[t])}static writeFile(t,e){file_util_js_1.FileUtil.checkFile(t),fs_extra_1.default.writeFileSync(t,fs_extra_1.default.readFileSync(e))}packRes(){this.needPackRes?(this._log._printDebugCommand("PackRes",this.packResCommand),(new process_utils_js_1.ProcessUtils).executeSync(this.packResCommand)):fs_extra_1.default.rmSync(this.packResPath,{force:!0})}}exports.PackageApp=PackageApp;