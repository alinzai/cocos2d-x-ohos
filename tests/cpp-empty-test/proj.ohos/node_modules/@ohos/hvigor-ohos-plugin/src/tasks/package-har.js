"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,s,t,i){void 0===i&&(i=t);var r=Object.getOwnPropertyDescriptor(s,t);r&&!("get"in r?!s.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return s[t]}}),Object.defineProperty(e,i,r)}:function(e,s,t,i){void 0===i&&(i=t),e[i]=s[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,s){Object.defineProperty(e,"default",{enumerable:!0,value:s})}:function(e,s){e.default=s}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var s={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(s,e,t);return __setModuleDefault(s,e),s},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackageHar=void 0;const json5_reader_js_1=require("@ohos/hvigor-base/src/util/json5-reader.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),system_util_js_1=require("../utils/system-util.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),path_1=__importDefault(require("path")),fs=__importStar(require("fs-extra")),process_utils_js_1=require("../utils/process-utils.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),npm_command_builder_js_1=require("../builder/npm-command-builder.js"),task_names_js_1=require("./common/task-names.js"),process_libs_js_1=require("./process-libs.js"),compile_resource_js_1=require("./compile-resource.js"),cmake_util_js_1=require("../utils/cmake-util.js"),file_set_js_1=require("@ohos/hvigor-base/src/internal/snapshot/util/file-set.js"),legacy_hook_compile_resource_js_1=require("./legacy-tasks/hook/legacy-hook-compile-resource.js"),log_combine_type_js_1=require("../utils/log/log-combine-type.js");var Task=task_names_js_1.TaskNames.Task;const pre_check_syscap_js_1=require("./pre-check-syscap.js");var CommonTask=task_names_js_1.TaskNames.CommonTask;const _log=ohos_logger_js_1.OhosLogger.getLogger("PackageHar"),isFileSpec=(0,system_util_js_1.isWindows)()?/^(?:[.]|~[/]|[/\\]|[a-zA-Z]:)/:/^(?:[.]|~[/]|[/]|[a-zA-Z]:)/,hasSlashes=(0,system_util_js_1.isWindows)()?/\\|[/]/:/[/]/,isFileName=/[.](?:tgz|tar.gz|tar)$/i;class PackageHar extends ohos_hap_task_js_1.OhosHapTask{constructor(e){var s,t;super(e,Task.PACKAGE_HAR),this.allInvalidPrefix=[],this._moduleDir=this.moduleModel.getProjectDir();const i=this.moduleModel.getProfileOpt();this._nativeOption=null===(s=i.buildOption)||void 0===s?void 0:s.externalNativeOptions;const r=this.targetService.getTargetData(),o=r.getPathInfo();this.resourceDir=o.getIntermediatesRes(),this.taskTmpDir=this.getTaskTempDir(r,void 0,!1),this.outputDir=o.getModuleBuildOutputPath(),this.processedLibs=o.getIntermediatesProcessLibs(),this.resourceTablePath=path_1.default.resolve(this.resourceDir,build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT),this.harProfile=o.getIntermediatesMergeProfileDir(),this.harModuleJson=path_1.default.resolve(this.taskTmpDir,"src","main",common_const_js_1.CommonConst.MODULE_JSON5),this.npmPath=path_1.default.dirname(process.execPath),this.cmakeListDir=cmake_util_js_1.CmakeUtil.getCmakeListDir(this._moduleDir,null===(t=this._nativeOption)||void 0===t?void 0:t.path),this.hasNativeOption=void 0===this._nativeOption,this.cppTypes=path_1.default.resolve(this.cmakeListDir,"types"),this.needCppTypes=fs.pathExistsSync(this.cppTypes),this.npmCommand=new npm_command_builder_js_1.NpmCommandBuilder(this.npmPath).addAllParams(["pack"]),this.syscapJsonPath=path_1.default.resolve(this.moduleModel.getSourceRootByTargetName(e.getTargetData().getTargetName()),common_const_js_1.CommonConst.SYSCAP_JSON);const a=[build_directory_const_js_1.BuildDirConst.LIBS,build_directory_const_js_1.BuildDirConst.BUILD_ROOT,common_const_js_1.CommonNodeConst.NODE_MODULES,".cxx",".previewer"];a.includes(o.getBuildRoot())||a.push(o.getBuildRoot()),a.forEach((e=>{this.allInvalidPrefix.push(path_1.default.resolve(this._moduleDir,e))}))}declareExecutionCommand(){return`${this.npmCommand.toString()}`}declareExecutionEnv(){return(new Map).set("cwd",this.taskTmpDir)}declareInputs(){const e=(new Map).set("hasNativeOption",this.hasNativeOption).set("needCppTypes",this.needCppTypes).set("harModuleJson",this.harModuleJson);return this.hasNativeOption&&e.set("cmakeListDir",this.cmakeListDir),this.hasNativeOption&&this.needCppTypes&&e.set("cppTypes",this.cppTypes),e}declareInputFiles(){const e=this.allInvalidPrefix.join("|").replace(/\\/g,"\\\\"),s=RegExp(`^(?!${e}).*`),t=(new file_set_js_1.FileSet).addEntry(this.harProfile,{isDirectory:!0}).addEntry(this._moduleDir,{isDirectory:!0,test:s});return fs.pathExistsSync(this.processedLibs)&&t.addEntry(this.processedLibs,{isDirectory:!0}),fs.pathExistsSync(this.resourceDir)&&t.addEntry(this.resourceTablePath,{isDirectory:!1}),t}declareOutputFiles(){return(new file_set_js_1.FileSet).addEntries([this.taskTmpDir,this.outputDir],{isDirectory:!0})}initTaskDepends(){this.module.registryDependsOnTask(this,new process_libs_js_1.ProcessLibs(this.targetService),this.isFaMode?new legacy_hook_compile_resource_js_1.LegacyHookCompileResource(this.targetService):new compile_resource_js_1.CompileResource(this.targetService)),fs.existsSync(this.syscapJsonPath)&&this.module.registryDependsOnTask(this,new pre_check_syscap_js_1.PreCheckSyscap(this.targetService,CommonTask.PRE_CHECK_SYSCAP))}doTaskAction(e){const s=this.moduleModel.getPackageJsonPath();PackageHar.checkHasLocalFileDependency(s)&&_log._buildError("Local dependencies are not supported during HAR build.")._file(s)._solution("Check the package.json file of the current library module and delete the local dependencies.")._printErrorAndExit(),fs.emptyDirSync(this.outputDir),fs.emptyDirSync(this.taskTmpDir),fs.pathExistsSync(this.processedLibs)&&fs.copySync(this.processedLibs,path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildDirConst.LIBS)),fs.pathExistsSync(this.resourceDir)&&fs.copySync(this.resourceTablePath,path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT)),fs.readdirSync(this._moduleDir).forEach((e=>{const s=path_1.default.resolve(this._moduleDir,e);this.allInvalidPrefix.includes(s)||fs.copySync(s,path_1.default.resolve(this.taskTmpDir,e),{filter:e=>!(this.hasNativeOption&&e===this.cmakeListDir)})})),this.hasNativeOption&&this.needCppTypes&&fs.copySync(this.cppTypes,path_1.default.resolve(this.taskTmpDir,"src","main","cpp","types")),fs.copySync(this.harProfile,path_1.default.resolve(this.taskTmpDir,"src","main")),fs.pathExistsSync(this.harModuleJson)&&fs.removeSync(this.harModuleJson);const t={moduleName:this.moduleName,taskName:this.name,commandLine:this.npmCommand,commandOptions:{cwd:this.taskTmpDir}},i=e=>{fs.copySync(this.taskTmpDir,this.outputDir,{filter:s=>!fs.lstatSync(s).isDirectory()&&s.endsWith(e)||s===this.taskTmpDir})};if(!new process_utils_js_1.ProcessUtils(this.moduleName,this.name).submitSyncExecutionWithReturn(this.getWorkerPool(),"packageHar",t,i)){i(new process_utils_js_1.ProcessUtils(this.moduleName,this.name).executeSync(t.commandLine,t.commandOptions,log_combine_type_js_1.LogCombineType.DEBUG).stdout.toString())}}static checkHasLocalFileDependency(e){const s=json5_reader_js_1.Json5Reader.getJson5Obj(e);return void 0!==s.dependencies&&Object.values(s.dependencies).some((e=>PackageHar.isLocalDependency(e)))}static isLocalDependency(e){return!!e&&(isFileSpec.test(e)||/^file:/i.test(e)||hasSlashes.test(e)||isFileName.test(e))}}exports.PackageHar=PackageHar;