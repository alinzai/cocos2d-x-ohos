"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,s){void 0===s&&(s=o);var a=Object.getOwnPropertyDescriptor(t,o);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,s,a)}:function(e,t,o,s){void 0===s&&(s=o),e[s]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.MakeProjectPackInfo=void 0;const ohos_app_task_js_1=require("./task/ohos-app-task.js"),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../const/build-directory-const.js"),fse=__importStar(require("fs-extra")),project_file_reader_js_1=require("../utils/project-file-reader.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),task_names_js_1=require("./common/task-names.js"),common_const_js_1=require("../const/common-const.js");var CommonHookTask=task_names_js_1.TaskNames.CommonHookTask;const file_set_js_1=require("@ohos/hvigor-base/src/internal/snapshot/util/file-set.js"),Task=task_names_js_1.TaskNames.Task;class MakeProjectPackInfo extends ohos_app_task_js_1.OhosAppTask{constructor(e,t){super(e,t,Task.MAKE_PROJECT_PACK_INFO),this.moduleSet=new Set,this._log=ohos_logger_js_1.OhosLogger.getLogger(MakeProjectPackInfo.name),this.hapPackInfoPathMap=new Map,this._projectPackInfoObj={summary:{app:{bundleName:"bundleName",version:{name:"name",code:0}},modules:[]},packages:[]},this.service.getProductDataMap().forEach((e=>{for(const t of e){const e=t.getModuleModel().getName(),o=t.getRelatedEntryModules();if(o.length)for(const s of o){const o=path_1.default.resolve(t.getPathInfo().getModuleBuildOutputPath(),s,build_directory_const_js_1.BuildArtifactConst.PACK_INFO);this.hapPackInfoPathMap.set(o,e)}else{const o=path_1.default.resolve(t.getPathInfo().getModuleBuildOutputPath(),build_directory_const_js_1.BuildArtifactConst.PACK_INFO);this.hapPackInfoPathMap.set(o,e)}}}))}declareInputFiles(){const e=new file_set_js_1.FileSet;for(const t of this.hapPackInfoPathMap.keys())e.addEntry(t);return e}declareOutputFiles(){const e=path_1.default.resolve(this.service.getPathInfo().getProjectOutputPath(),build_directory_const_js_1.BuildArtifactConst.PACK_INFO);return(new file_set_js_1.FileSet).addEntry(e)}initTaskDepends(){this.service.getProjectModel().getSubProjects().forEach((e=>{const t=e,o=this.isNeedPackageHap(t);t.isHapModule()&&o&&this.dependsOn(CommonHookTask.ASSEMBLE_HAP.name,e.getName())}))}isNeedPackageHap(e){const t=this.service.getTargetProduct().name,o=this.service.getProjectModel().getModuleProfileOpt(e.getName()),s=null==o?void 0:o.targets;return void 0!==s&&s.some((e=>{const o=e.name;let s=e.applyToProducts;return void 0===s&&(s=["default"]),o!==common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&s.includes(t)}))}doTaskAction(){this.hapPackInfoPathMap.forEach(((e,t)=>{this.mergeHapPackInfo(t,e)})),this._log.debug("Project Pack Info:",this._projectPackInfoObj),fse.outputJSONSync(path_1.default.resolve(this.service.getPathInfo().getProjectOutputPath(),build_directory_const_js_1.BuildArtifactConst.PACK_INFO),this._projectPackInfoObj,{spaces:"\t"}),this.moduleSet.clear()}mergeHapPackInfo(e,t){if(fse.existsSync(e)){const o=project_file_reader_js_1.ProjectFileReader.getJson5Obj(e);this._projectPackInfoObj.summary.app=o.summary.app,this.moduleSet.has(t)||(this._projectPackInfoObj.summary.modules.push(o.summary.modules[0]),this.moduleSet.add(t)),this._projectPackInfoObj.packages.push(o.packages[0])}}}exports.MakeProjectPackInfo=MakeProjectPackInfo;