"use strict";var __importDefault=this&&this.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CommonSignCommandBuilder=void 0;const fs_1=__importDefault(require("fs")),ohos_logger_js_1=require("../../../utils/log/ohos-logger.js"),decipher_util_js_1=require("../../../utils/decipher-util.js"),path_1=__importDefault(require("path")),error_url_js_1=require("../../../utils/error-url.js");class CommonSignCommandBuilder{constructor(i,e,t,r,o){this._log=ohos_logger_js_1.OhosLogger.getLogger(CommonSignCommandBuilder.name),this._projectModel=i,this._signingConfig=e,this._sdkInfo=t,this._signModel=r,this._signingOptions=o}getSignCommand(){const i=this._signingConfig.material;return this.checkValidMaterial(i),this.initCommandParams(i),this._signingOptions.addCalledJarFile(this.getSignTool()),this._signingOptions.build()}getKeyStorePwd(){return decipher_util_js_1.DecipherUtil.decryptPwd(path_1.default.resolve(this._signingConfig.material.storeFile,".."),this._signingConfig.material.storePassword)}getKeyPwd(){return decipher_util_js_1.DecipherUtil.decryptPwd(path_1.default.resolve(this._signingConfig.material.storeFile,".."),this._signingConfig.material.keyPassword)}checkValidMaterial(i){const e="Please check signingConfigs in root project build-profile.json5";void 0===i&&this._log._buildError("The material has not been configured in signingConfigs.")._solution(e)._file(this._projectModel.getProfilePath())._printErrorAndExit(this._projectModel.getName()),this.validateMaterial(i.storeFile,e,"storeFile"),this.validateMaterial(i.profile,e,"profile"),this.validateMaterial(i.certpath,e,"certPath"),i.storeFile=this.normalizePath(i.storeFile),i.profile=this.normalizePath(i.profile),i.certpath=this.normalizePath(i.certpath)}normalizePath(i){return path_1.default.isAbsolute(i)?i:path_1.default.resolve(this._projectModel.getProjectDir(),i)}validateMaterial(i,e,t){if(void 0!==i&&fs_1.default.existsSync(this.normalizePath(i)))return;const r=`Invalid ${t} value. Make sure it is not null or empty. The file must be included in '${i}'.`;this._log._buildError(r)._solution(e)._file(this._projectModel.getProfilePath())._printErrorAndExit(this._projectModel.getName())}validateSignType(i){void 0===this._signingConfig.type&&(this._signingConfig.type="OpenHarmony"),this._signingConfig.type!==i&&this._log._buildError(`Signing configuration '${this._signingConfig.name}' does not apply to '${i}'. The HAP installation may fail.`)._solution(`see ${error_url_js_1.ErrorUrl.ERROR_URL.sign}`)._file(this._projectModel.getProfilePath())._printErrorAndExit(this._projectModel.getName())}}exports.CommonSignCommandBuilder=CommonSignCommandBuilder;