"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,o){void 0===o&&(o=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,o,r)}:function(e,t,i,o){void 0===o&&(o=i),e[o]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CoreProjectModelImpl=void 0;const fs=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),common_const_js_1=require("../../const/common-const.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),array_util_js_1=require("../../utils/array-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),project_file_reader_js_1=require("../../utils/project-file-reader.js"),validate_util_js_1=require("../../utils/validate-util.js"),legacy_module_model_impl_js_1=require("../module/legacy-module-model-impl.js"),module_model_impl_js_1=require("../module/module-model-impl.js"),hvigor_base_1=require("@ohos/hvigor-base"),command_line_util_js_1=require("../../utils/command-line-util.js");class CoreProjectModelImpl{constructor(e,t=!1){this.subModels=new Map,this._log=ohos_logger_js_1.OhosLogger.getLogger(CoreProjectModelImpl.name),this.project=e,this.projectPath=e.getNodeDir(),this.name=e.getName(),this._profilePath=path_1.default.resolve(this.projectPath,common_const_js_1.CommonConst.PROFILE_JSON5),this.projectBuildProfileCheck(this._profilePath),this._profileOptions=project_file_reader_js_1.ProjectFileReader.getJson5Obj(this.getProfilePath()),this._productNames=this._profileOptions.app.products.map((e=>e.name)),this.projectStatusCheck(),this.initSubProject(t);const i=hvigor_base_1.hvigor.getExtraConfig().get("module");this._moduleSpecificTargets=(0,command_line_util_js_1.parseTargets)(i)}projectStatusCheck(){const e=this.getCompileApiVersion(),t=this.getCompatibleApiVersion();e<8&&this._log._buildError("Hvigor only works with API version 8 and later versions.")._solution(`Change compileSdkVersion:'${e}'.`)._file(this._profilePath)._printErrorAndExit(this.name),t>e&&this._log._buildError("CompatibleSdkVersion can not be larger than compileSdkVersion.")._solution(`Change compileSdkVersion: ${e} or compatibleSdkVersion: ${t}.`)._file(this._profilePath)._printErrorAndExit(this.name),validate_util_js_1.ValidateUtil.validateContainsDefault(this._profileOptions.app.products,this._profilePath),validate_util_js_1.ValidateUtil.validateDuplicatedName(this._profileOptions.app.products,"products",this._profilePath),validate_util_js_1.ValidateUtil.validateDuplicatedName(this._profileOptions.app.signingConfigs,"signingConfigs",this._profilePath),validate_util_js_1.ValidateUtil.validateDuplicatedName(this._profileOptions.modules,"modules",this._profilePath),this._profileOptions.modules.forEach((e=>validate_util_js_1.ValidateUtil.validateDuplicatedName(e.targets,"targets",this._profilePath)))}initSubProject(e){this.project.getSubModules().forEach(((t,i)=>{this.subModels.set(i,e?new legacy_module_model_impl_js_1.LegacyModuleModelImpl(t,this):new module_model_impl_js_1.ModuleModelImpl(t,this))}))}getBuildProfileName(){return common_const_js_1.CommonConst.PROFILE_JSON5}getName(){return this.name}getPackageJsonPath(){return path_1.default.resolve(this.projectPath,common_const_js_1.CommonConst.PACKAGE_JSON)}getProfilePath(){return this._profilePath}getProjectDir(){return this.projectPath}getProductNames(){return this._productNames}getProfileOpt(){return this._profileOptions}getSubProjects(){return this.subModels}getModuleModelByName(e){return this.subModels.get(e)}getCompileApiVersion(){return this.getProfileOpt().app.compileSdkVersion}getCompatibleApiVersion(){return this.getProfileOpt().app.compatibleSdkVersion}getAllModules(){return[...this.subModels.values()]}getAllEntryModules(){const e=new Set;return this.subModels.forEach(((t,i)=>{t.getModuleType()===module_type_enum_js_1.ModuleType.Entry&&e.add(i)})),e}getTargetApplyProducts(e,t){const i=(0,array_util_js_1.getElementFromArr)(this._profileOptions.modules,e);if(void 0===i)return;const o=(0,array_util_js_1.getElementFromArr)(i.targets,t);return void 0!==o?o.applyToProducts:void 0}getModuleProfileOpt(e){return(0,array_util_js_1.getElementFromArr)(this._profileOptions.modules,e)}getModuleSpecificTargets(){return this._moduleSpecificTargets}projectBuildProfileCheck(e){const t=path_1.default.resolve(__dirname,"../../../res/schemas/ohos-project-build-profile-schema.json"),i=path_1.default.resolve(__dirname,"../../../res/schemas/ohos-module-build-profile-schema.json");fs.existsSync(e)||this._log._buildError("Can not find build config file build-profile.json5.")._file(e)._printErrorAndExit(this.name),validate_util_js_1.ValidateUtil.submitSchemaCheckWork(this.name,e,i,!1,!0)&&this._log._buildError("The project-level build-profile.json5 file does not comply with the schema. This may occur when the build-profile.json5 file is directly copied from another module, or when the module's hvigorfile requires appTasks instead of hapTasks/harTasks.")._solution("Make sure build-profile.json5 and hvigorfile are configured correctly.")._file(path_1.default.resolve(this.projectPath,common_const_js_1.CommonConst.BUILD_FILE_NAME))._printErrorAndExit(this.name),validate_util_js_1.ValidateUtil.submitSchemaCheckWork(this.name,e,t,!1)}}exports.CoreProjectModelImpl=CoreProjectModelImpl;