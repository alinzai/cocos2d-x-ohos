"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o);var i=Object.getOwnPropertyDescriptor(t,o);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,r,i)}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CoreModuleModelImpl=void 0;const common_const_js_1=require("../../const/common-const.js"),path_1=__importDefault(require("path")),module_type_enum_js_1=require("../../enum/module-type-enum.js"),project_file_reader_js_1=require("../../utils/project-file-reader.js"),fs=__importStar(require("fs-extra")),validate_util_js_1=require("../../utils/validate-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),hap_extra_info_js_1=require("../../project/data/hap-extra-info.js"),array_util_js_1=require("../../utils/array-util.js"),compile_mode_enum_js_1=require("../../enum/compile-mode-enum.js"),log=ohos_logger_js_1.OhosLogger.getLogger("ohos-core-module-model");class CoreModuleModelImpl{constructor(e,t){this.targetSourceSetMap=new Map,this.module=e,this.name=e.getName(),this.modulePath=e.getNodeDir(),this.parentProject=t,this.buildProfilePath=path_1.default.resolve(this.modulePath,common_const_js_1.CommonConst.PROFILE_JSON5),this.moduleBuildOpt=project_file_reader_js_1.ProjectFileReader.getJson5Obj(this.getProfilePath()),this.moduleBuildProfileCheck(this.buildProfilePath),this._sourceRootDir=path_1.default.resolve(this.modulePath,"src"),this.processTargetsConfig(),this.initDefaultTargetSourceSet()}getRelatedEntryModules(){if(this.getModuleType()!==module_type_enum_js_1.ModuleType.Feature)return[];const e=this.getProfileOpt().entryModules;void 0===e&&log._buildError("'entryModules' must be configured for a feature module.")._solution("Set 'entryModules' in the build-profile.json5 file.")._file(this.getProfilePath())._printErrorAndExit(this.getName());const t=this.parentProject.getAllEntryModules();return e.every((e=>t.has(e)))||log._buildError("No available entry module found.")._solution("Check 'entryModules' in the build-profile.json5 file.")._file(this.getProfilePath())._printErrorAndExit(this.getName()),e.filter((e=>t.has(e)))}getSourceRootByTargetName(e=common_const_js_1.DefaultTargetConst.DEFAULT_TARGET){return this.targetSourceSetMap.has(e)?this.targetSourceSetMap.get(e).getSourceSetRoot():this.targetSourceSetMap.get(common_const_js_1.DefaultTargetConst.DEFAULT_TARGET).getSourceSetRoot()}getBuildProfileName(){return common_const_js_1.CommonConst.PROFILE_JSON5}getName(){return this.name}getProjectDir(){return this.modulePath}getParentProject(){return this.parentProject}getPackageJsonPath(){return path_1.default.resolve(this.modulePath,common_const_js_1.CommonConst.PACKAGE_JSON)}getProfilePath(){return this.buildProfilePath}getProfileOpt(){return this.moduleBuildOpt}isArkModule(){return!0}isHapModule(){return this.getModuleType()!==module_type_enum_js_1.ModuleType.Har}isHarModule(){return this.getModuleType()===module_type_enum_js_1.ModuleType.Har}getCompileApiVersion(){return this.getParentProject().getProfileOpt().app.compileSdkVersion}getCompatibleApiVersion(){return this.getParentProject().getProfileOpt().app.compatibleSdkVersion}getAllModules(){return this.parentProject.getAllModules()}getApiType(){return void 0===this.moduleBuildOpt.apiType?hap_extra_info_js_1.ApiType.STAGE:this.moduleBuildOpt.apiType}getCompileMode(){var e;const t=null===(e=this.getProfileOpt().buildOption)||void 0===e?void 0:e.compileMode;return void 0===t?compile_mode_enum_js_1.CompileModeEnum.JS_BUNDLE:t}moduleBuildProfileCheck(e){const t=path_1.default.resolve(__dirname,"../../../res/schemas/ohos-module-build-profile-schema.json");fs.existsSync(e)||log._buildError("Can not find build config file build-profile.json5.")._file(e)._printErrorAndExit(this.name),validate_util_js_1.ValidateUtil.submitSchemaCheckWork(this.name,e,t,!1),validate_util_js_1.ValidateUtil.validateDuplicatedName(this.getProfileOpt().targets,"targets",e)}getModule(){return this.module}processTargetsConfig(){const e=(0,array_util_js_1.getElementFromArr)(this.moduleBuildOpt.targets,"default"),t=(0,array_util_js_1.getElementFromArr)(this.moduleBuildOpt.targets,"ohosTest");void 0!==t&&void 0===t.runtimeOS&&(t.runtimeOS=null==e?void 0:e.runtimeOS)}}exports.CoreModuleModelImpl=CoreModuleModelImpl;