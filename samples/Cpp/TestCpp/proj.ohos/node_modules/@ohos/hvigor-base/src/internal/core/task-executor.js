"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.taskExecutorInst=exports.TaskExecutor=void 0;const hvigor_log_js_1=require("../../log/hvigor-log.js"),task_control_center_js_1=require("../task/core/task-control-center.js"),task_control_center_listener_register_js_1=require("../task/core/listener/task-control-center-listener-register.js"),hvigor_process_js_1=require("../lifecycle/hvigor-process.js"),task_execute_status_js_1=require("../task/core/task-execute-status.js"),task_listener_event_id_js_1=require("../task/core/listener/task-listener-event-id.js"),task_util_js_1=require("../../util/task-util.js"),process_1=__importDefault(require("process")),incremental_task_executor_js_1=require("./incremental-task-executor.js"),event_id_options_js_1=require("../lifecycle/event/event-id-options.js"),time_util_js_1=require("../../util/time-util.js"),_log=hvigor_log_js_1.HvigorLogger.getLogger("hvigor-task-executor");class TaskExecutor{executeTaskByName(e){task_control_center_js_1.taskControlCenter.initTaskQueueBeforeRun(e),task_control_center_listener_register_js_1.taskControlCenterListenerRegister.registryAllDefault();const t=setInterval((()=>{const e=task_control_center_js_1.taskControlCenter.popRunnableTask();if(void 0!==e)if(hvigor_process_js_1.hvigorProcess.hasTaskDone=!0,e.taskExecutedStatus.setState(task_execute_status_js_1.TASK_EXECUTE_STATUS.PENDING),executeOneTask(e)){if(!e.getEnabled())return;e.taskExecutedStatus.isUpToDate()?task_control_center_js_1.taskControlCenter.emit(task_listener_event_id_js_1.TASK_CENTER_TASK_EVENT_ID.TASK_UP_TO_DATE,e.getPath()):e.taskExecutedStatus.allWorksHasFinished()&&task_control_center_js_1.taskControlCenter.emit(task_listener_event_id_js_1.TASK_CENTER_TASK_EVENT_ID.TASK_FINISHED,e.getPath())}else clearInterval(t);process_1.default.nextTick((()=>{task_control_center_js_1.taskControlCenter.allTasksHasExecuted()&&void 0===e&&(clearInterval(t),hvigor_process_js_1.hvigorProcess.emit(event_id_options_js_1.HVIGOR_PROCESS_EVENT_ID.FINISHED))}))}),1);task_control_center_js_1.taskControlCenter.setIntervalId(t),logConfigurationCostTime()}}function logConfigurationCostTime(){const e=process_1.default.hrtime(hvigor_process_js_1.hvigorProcess.taskBeginTime),t=(0,time_util_js_1.formatTime)(e);_log.debug(`Configuration task cost before running: ${t}`)}function executeOneTask(e){try{return e.taskExecutedStatus.setState(task_execute_status_js_1.TASK_EXECUTE_STATUS.RUNNING),e.metric.start(),task_control_center_js_1.taskControlCenter.pushRunningTask(e),e.getEnabled()?((0,task_util_js_1.isIncrementalTask)(e)?(0,incremental_task_executor_js_1.doIncrementalTask)(e):e.execute(),!0):(task_control_center_js_1.taskControlCenter.emit(task_listener_event_id_js_1.TASK_CENTER_TASK_EVENT_ID.TASK_DISABLED,e.getPath()),!0)}catch(t){return!(t instanceof Error)||(task_control_center_js_1.taskControlCenter.emit(task_listener_event_id_js_1.TASK_CENTER_TASK_EVENT_ID.TASK_FAILED,e.getPath()),hvigor_process_js_1.hvigorProcess.error(t),!1)}}exports.TaskExecutor=TaskExecutor,exports.taskExecutorInst=new TaskExecutor;