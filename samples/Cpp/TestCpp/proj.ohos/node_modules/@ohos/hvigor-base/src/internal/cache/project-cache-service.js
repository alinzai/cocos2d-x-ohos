"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProjectCacheService=void 0;const tasksnapshot_cache_service_js_1=require("./service/tasksnapshot-cache-service.js"),filesnapshot_cache_service_js_1=require("./service/filesnapshot-cache-service.js"),path_1=__importDefault(require("path")),cache_util_js_1=require("./util/cache-util.js"),snapshot_generator_service_js_1=require("../snapshot/service/snapshot-generator-service.js"),local_file_writer_js_1=require("../../util/local-file-writer.js"),task_converter_js_1=require("../task/proxy/task-converter.js"),index_js_1=require("../../../index.js");class ProjectCacheService{constructor(e){this.project=e,this.projectName=e.getName(),this.taskSnapShotCacheService=new tasksnapshot_cache_service_js_1.TaskSnapShotCacheService(this.getProjectTaskSnapShotCacheFilePath()),this.fileSnapShotCacheService=new filesnapshot_cache_service_js_1.FileSnapShotCacheService(this.getProjectFileSnapShotCacheFilePath()),this.currentTaskSnapShotCacheService=new tasksnapshot_cache_service_js_1.TaskSnapShotCacheService(this.getProjectTaskSnapShotCacheFilePath()),this.currentFileSnapShotCacheService=new filesnapshot_cache_service_js_1.FileSnapShotCacheService(this.getProjectFileSnapShotCacheFilePath())}getProjectFileSnapShotCacheFilePath(){return path_1.default.resolve(this.project.getNodeDir(),"./.hvigor/cache/file-cache.json")}getProjectTaskSnapShotCacheFilePath(){return path_1.default.resolve(this.project.getNodeDir(),"./.hvigor/cache/task-cache.json")}initialize(){this.taskSnapShotCacheService.initialize(),this.fileSnapShotCacheService.initialize(),this.currentTaskSnapShotCacheService.clone(this.taskSnapShotCacheService),this.currentFileSnapShotCacheService.clone(this.fileSnapShotCacheService)}getTaskSnapShot(e,t){return this.taskSnapShotCacheService.get((0,cache_util_js_1.getTaskSnapCacheEntryUniqueKey)(e,t))}getFileSnapShot(e){return this.fileSnapShotCacheService.get(e)}updateFileSnapShot(e,t){this.currentFileSnapShotCacheService.set(e,t)}updateTaskSnapShot(e,t){this.currentTaskSnapShotCacheService.set(e,t)}close(){if(!index_js_1.hvigor.startParameters.incrementalExecution)return;task_converter_js_1.taskConVert.getAllIncrementalTaskProxy().forEach((e=>{e.postExecute()}));const e=snapshot_generator_service_js_1.SnapshotGeneratorService.getInstance().serializeTaskSnapshotCacheToJson(this.currentTaskSnapShotCacheService.getCacheEntryContentMap()),t=snapshot_generator_service_js_1.SnapshotGeneratorService.getInstance().serializeFileSystemSnapshotToJson(this.currentFileSnapShotCacheService.getCacheEntryContentMap());try{local_file_writer_js_1.LocalFileWriter.getInstance().writeStr(this.getProjectTaskSnapShotCacheFilePath(),e),local_file_writer_js_1.LocalFileWriter.getInstance().writeStr(this.getProjectFileSnapShotCacheFilePath(),t)}catch(e){}}static getInstance(e){return ProjectCacheService.instance||(ProjectCacheService.instance=new ProjectCacheService(e)),ProjectCacheService.instance}}exports.ProjectCacheService=ProjectCacheService;