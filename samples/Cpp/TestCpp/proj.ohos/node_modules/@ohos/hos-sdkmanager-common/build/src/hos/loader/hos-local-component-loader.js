"use strict";var __importDefault=this&&this.__importDefault||function(o){return o&&o.__esModule?o:{default:o}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.HosLocalComponentLoader=void 0;const hos_component_constants_1=require("../const/hos-component-constants"),path_1=__importDefault(require("path")),sdkmanager_common_1=require("@ohos/sdkmanager-common"),fs_1=__importDefault(require("fs")),hos_component_dto_1=require("./hos-component-dto"),loader_util_1=require("./loader-util"),hos_location_mapper_1=require("./hos-location-mapper");class HosLocalComponentLoader extends sdkmanager_common_1.AbstractLocalComponentLoader{constructor(o,e){super(HosLocalComponentLoader.MAX_SCAN_DEPTH,o,e),this._inCompatibleComponents=new Array}parseSdks(o){const e=new Map;for(const t of o)try{const o=fs_1.default.readFileSync(t,{encoding:"utf-8"}),n=JSON.parse(o),s=this._convertComponent(n,t);if(!this.isValidComponent(s))continue;if(!this._isSameMetaVersion(s))continue;if(this._isIncompatibleComponent(s))continue;if(!this._isComponentInRightPlace(s)){this.progress.debug(`Component ${s.getDisplayName()}:${s.getVersion()} has been placed in the wrong place,\n             expect ${s.getLocation()}, actual ${path_1.default.resolve(t,"..")}`);continue}this.addToMap(e,s),this._duplicateToolchainsIfNecessary(e,s)}catch(o){this.progress.warn(`Failed to get uni-package info, ${o.message}`)}const t=[];return e.forEach((o=>t.push(o))),t}getUniPackageName(){return hos_component_constants_1.HOS_UNI_PACKAGE_NAME}_convertComponent(o,e){const t=new hos_component_dto_1.HosComponentDto;t.path=o.path,t.version=o.version,t.releaseType=o.releaseType,t.displayName=o.displayName;const n=Number(o.apiVersion);return Number.isNaN(n)||(t.apiVersion=n),this._configMeta(o,t),(0,loader_util_1.mapToolchainsApiVersion)(t),t.displayName=this.convertDisplayName(t),t.location=path_1.default.resolve(e,".."),t}_configMeta(o,e){var t;const n=new sdkmanager_common_1.MetaDto,s=null===(t=o.meta)||void 0===t?void 0:t.metaVersion;return(0,sdkmanager_common_1.isEmpty)(s)?hos_component_constants_1.LEGACY_VERSIONS.includes(e.version)?(n.metaVersion=hos_component_constants_1.VERSION_1_0_0,void(e.meta=n)):(n.metaVersion=hos_component_constants_1.VERSION_2_0_0,void(e.meta=n)):(n.metaVersion=s,void(e.meta=n))}_isSameMetaVersion(o){var e;const t=null===(e=o.getMeta())||void 0===e?void 0:e.getMetaVersion();if((0,sdkmanager_common_1.isEmpty)(t)||!sdkmanager_common_1.META_VERSION_PATTERN.test(t))return this.progress.debug(`Illegal component ${o.displayName}:${o.version}, Incorrect meta version ${t}`),!1;return 0===(0,sdkmanager_common_1.compareVersion)(t,hos_component_constants_1.SUPPORT_META_VERSION)||(this._inCompatibleComponents.push(o),!1)}_isComponentInRightPlace(o){return o.getLocation()===this._getExpectedLocation(o)||(this._inCompatibleComponents.push(o),!1)}_getExpectedLocation(o){const e=(0,hos_location_mapper_1.generatePath)(o);return(0,sdkmanager_common_1.isEmpty)(e)?"":path_1.default.resolve(this._getHmsSdkRoot(),e)}getSdkRoot(){return this.sdkRoot}_getHmsSdkRoot(){return path_1.default.resolve(this.getSdkRoot(),hos_component_constants_1.HMSCORE)}_duplicateToolchainsIfNecessary(o,e){if(sdkmanager_common_1.ComponentPath.TOOLCHAINS===e.getPath()&&hos_component_constants_1.TOOLCHAINS_6_5_4_VERSION===e.getVersion()){const t=JSON.parse(JSON.stringify(e));Object.setPrototypeOf(t,hos_component_dto_1.HosComponentDto.prototype),t.apiVersion=4,super.addToMap(o,t);const n=JSON.parse(JSON.stringify(e));Object.setPrototypeOf(n,hos_component_dto_1.HosComponentDto.prototype),n.apiVersion=5,super.addToMap(o,n)}}getInCompatibleComponents(){return this._inCompatibleComponents}_isIncompatibleComponent(o){return sdkmanager_common_1.ComponentPath.EMULATOR===o.path&&(0,sdkmanager_common_1.compareVersion)(o.version,hos_component_constants_1.EMULATOR_INCOMPATIBLE_VERSION)<=0&&(this._inCompatibleComponents.push(o),!0)}}exports.HosLocalComponentLoader=HosLocalComponentLoader,HosLocalComponentLoader.MAX_SCAN_DEPTH=5;