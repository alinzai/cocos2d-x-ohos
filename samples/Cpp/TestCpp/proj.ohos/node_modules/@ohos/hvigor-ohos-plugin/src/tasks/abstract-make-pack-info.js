"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,s){void 0===s&&(s=a);var o=Object.getOwnPropertyDescriptor(t,a);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,s,o)}:function(e,t,a,s){void 0===s&&(s=a),e[s]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractMakePackInfo=void 0;const ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),fse=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),file_set_js_1=require("@ohos/hvigor-base/src/internal/snapshot/util/file-set.js");class AbstractMakePackInfo extends ohos_hap_task_js_1.OhosHapTask{declareInputs(){const e=this.projectModel.getProfileOpt().app,t=new Map,a=this.targetData.getProduct().bundleName;a&&t.set("bundleName",a);const s=this.targetData.getTargetDeviceType();return t.set("deviceTypes",s),t.set("compileSdkVersion",e.compileSdkVersion),t.set("compatibleSdkVersion",e.compatibleSdkVersion),t}declareOutputFiles(){const e=new file_set_js_1.FileSet,t=this.service.getRelatedEntryModules();if(0===t.length){const t=path_1.default.resolve(this.pathInfo.getModuleBuildOutputPath(),"",build_directory_const_js_1.BuildArtifactConst.PACK_INFO);e.addEntry(t)}else for(const a of t)if(this.projectModel.getModuleModelByName(a)){const t=path_1.default.resolve(this.pathInfo.getModuleBuildOutputPath(),a,build_directory_const_js_1.BuildArtifactConst.PACK_INFO);e.addEntry(t)}return e}doMakePackInfo(e,t,a,s,o=!1){const i=this.targetData.getTargetDeviceType(),r=this.targetData.getTargetName(),n=a.getJsonObjByTargetName(r),u=this.getModuleObj(i,a,void 0,r),l=this.service.getRelatedEntryModules();let d;if(r===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET){const e=o?n.app.apiVersion:void 0;d=this.getModuleObj(i,a,e,common_const_js_1.DefaultTargetConst.DEFAULT_TARGET)}if(this.noRelatedEntryModules(l)){const t=d?[u,d]:[u];this.buildPackInfo(e,"",n,s,t,void 0)}else for(const a of l)if(t.getModuleModelByName(a)){const l=this.targetData.findTargetDataByName(a);this.checkEntryTarget(e,this.targetData.getTargetName(),a,l,o);const c=t.getModuleModelByName(a),p=o?n.app.apiVersion:void 0,_=o?l.getTargetDeviceType():this.getEntryDeviceType(l,c),h=[u,this.getModuleObj(this.getDeviceTypeSubset(e,a,_,i),c,p,r)];if(d){const t=this.getModuleObj(this.getDeviceTypeSubset(e,a,_,i),c,p,common_const_js_1.DefaultTargetConst.DEFAULT_TARGET);h.push(d,t)}this.buildPackInfo(e,a,n,s,h,c.getJsonObjByTargetName(r))}}buildPackInfo(e,t,a,s,o,i){var r,n;const u=this.targetData.getModuleTargetOutputFileName(t,null),l=u.substring(0,u.lastIndexOf(".hap")),d=i?this.getPackageObj(null!==(r=this.targetData.findTargetDataByName(t))&&void 0!==r?r:this.targetData,a,l):this.getPackageObj(null!==(n=this.targetData.findTargetDataByName(t))&&void 0!==n?n:this.targetData,a,l),c=this.getPackInfoObj(s,o,d);this.outputJSON(e,c,this.targetData.getPathInfo().getModuleBuildOutputPath(),t)}processForms(e){if(void 0===e)return;const t=[];for(let a=0;a<e.length;a++){const s=e[a],o={name:s.name,type:"JS",updateEnabled:s.updateEnabled,scheduledUpdateTime:s.scheduledUpdateTime,updateDuration:s.updateDuration,supportDimensions:s.supportDimensions,defaultDimension:s.defaultDimension};t.push(o)}return t}processAbilities(e){if(void 0===e)return;const t=[];for(const{forms:a,label:s,name:o,visible:i}of e){const e={name:o,label:s,visible:i,forms:this.processForms(a)};t.push(e)}return t}outputJSON(e,t,a,s){e.debug("Module Pack Info: ",t),fse.outputJSONSync(path_1.default.resolve(a,s,build_directory_const_js_1.BuildArtifactConst.PACK_INFO),t)}getPackInfoObj(e,t,a){return{summary:{app:e,modules:t},packages:[a]}}noRelatedEntryModules(e){return 0===e.length}checkEntryTarget(e,t,a,s,o){!s&&o&&e._buildError(`Unable to find '${t}' in module ${a}. Make sure module ${this.moduleName} has the same target as ${a}.`)._printErrorAndExit(this.moduleName)}getEntryDeviceType(e,t){return e?e.getTargetDeviceType():t.getDeviceTypes()}getDeviceTypeSubset(e,t,a,s){const o=new Set(s),i=a.filter((e=>o.has(e)));return 0===i.length&&e.warn(`The device types of ${this.moduleModel.getName()} and ${t} are different. Invalid HAP ${this.moduleModel.getName()}.`),i}}exports.AbstractMakePackInfo=AbstractMakePackInfo;