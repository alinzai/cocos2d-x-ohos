"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,o){void 0===o&&(o=i);var d=Object.getOwnPropertyDescriptor(t,i);d&&!("get"in d?!t.__esModule:d.writable||d.configurable)||(d={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,o,d)}:function(e,t,i,o){void 0===o&&(o=i),e[o]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GenerateShellManifest=void 0;const fast_xml_parser_1=require("fast-xml-parser"),fs=__importStar(require("fs-extra")),lodash_1=require("lodash"),path=__importStar(require("path")),sdk_const_1=require("../../const/sdk-const"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),runtime_type_enum_js_1=require("../../enum/runtime-type-enum.js"),inject_util_js_1=require("../../utils/inject-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),shell_utils_js_1=require("../../utils/shell-utils.js"),xml_utils_1=require("../../utils/xml-utils"),task_names_js_1=require("../common/task-names.js"),ohos_hap_task_1=require("../task/ohos-hap-task"),compile_shell_resource_js_1=require("./compile-shell-resource.js");var ShellTask=task_names_js_1.TaskNames.ShellTask;class GenerateShellManifest extends ohos_hap_task_1.OhosHapTask{constructor(e){super(e,ShellTask.GENERATE_SHELL_MANIFEST),this.configRule=require("../../../res/rules/config_rule.json"),this._log=ohos_logger_js_1.OhosLogger.getLogger(GenerateShellManifest.name),this._builder=new fast_xml_parser_1.XMLBuilder(xml_utils_1.XMLOption),this._moduleModel=this.service.getModuleModel()}initTaskDepends(){this.module.registryDependsOnTask(this,new compile_shell_resource_js_1.CompileShellResource(this.targetService))}taskShouldDo(e){return e.getTargetStatus().is(runtime_type_enum_js_1.RuntimeTypeEnum.HARMONY_OS)}doTaskAction(e){var t,i,o;this._targetData=e,this._moduleTargetRes=this._moduleModel.getSourceSetByTargetName(e.getTargetName()).getLegacyModuleTargetRes(),this._configObj=this._moduleTargetRes.getConfigJsonOpt(),this._pathInfo=e.getPathInfo(),this._moduleType=this._moduleModel.getModuleType(e.getTargetName()),this.generateManifest();const d=null===(i=null===(t=this._configObj)||void 0===t?void 0:t.deviceConfig.default)||void 0===i?void 0:i.network;(null===(o=null==d?void 0:d.securityConfig)||void 0===o?void 0:o.domainSettings)&&this.generateNetworkConfig()}generateManifest(){const e=new xml_utils_1.XMLNode;e.addPI();const t=xml_utils_1.XMLNode.initByAttrsAndParent({package:this._configObj.app.bundleName,"android:versionCode":this._configObj.app.version.code,"android:versionName":this._configObj.app.version.name},e,"manifest");t.addNamespace("android","http://schemas.android.com/apk/res/android").addNamespace("tools","http://schemas.android.com/tools"),this._moduleType===module_type_enum_js_1.ModuleType.Feature&&t.addNamespace("dist","http://schemas.android.com/apk/distribution"),t.addNode("uses-feature",xml_utils_1.XMLNode.initByAttrs({"android:name":"zidane.software.ability","android:required":"false"})).addNode("uses-sdk",xml_utils_1.XMLNode.initByAttrs({"android:minSdkVersion":sdk_const_1.ToolChainsConst.SHELL_MIN_SDK_VERSION,"android:targetSdkVersion":sdk_const_1.ToolChainsConst.SHELL_TARGET_SDK_VERSION})),this.addConfig2Node(t);const i=path.resolve(this._pathInfo.getShellSrcMain(),"AndroidManifest.xml");if(fs.outputFileSync(i,this._builder.build(e.build())),this._moduleModel.getModuleType()!==module_type_enum_js_1.ModuleType.Entry)return;t.node.application.activity=void 0,t.node.application.service=void 0,t.node.application.provider=void 0,t.node.application["activity-alias"]=void 0;const o=path.resolve(this._pathInfo.getShellSrcMain(),"cut","AndroidManifest.xml");fs.outputFileSync(o,this._builder.build(e.build()))}addConfig2Node(e){var t,i,o;this.addDefPermissionInfo2Node(this._configObj.module,e),this.addReqPermissionsInfo2Node(this._configObj.module,e),this.addDefPermissionGroupsInfo2Node(this._configObj.module,e);const d=xml_utils_1.XMLNode.initByParent(e,"application");d.addNode("meta-data",xml_utils_1.XMLNode.initByAttrs({"android:name":"permZA","android:value":"true"}));const s=null===(i=null===(t=this._configObj)||void 0===t?void 0:t.module)||void 0===i?void 0:i.resizeable;d.addAttr("android:resizeableActivity",null==s?void 0:s.toString()),inject_util_js_1.InjectUtil.isDebug()&&d.addAttr("android:debuggable",!0);const a=null===(o=this._moduleTargetRes)||void 0===o?void 0:o.getShellApplicationPackage();a&&d.addAttr("android:name",a),this.addDeviceConfig2Node(d),this.addModule2Node(d,e),this.addIconLabel(d)}generateNetworkConfig(){const e=new xml_utils_1.XMLNode;e.addPI();const t=xml_utils_1.XMLNode.initByParent(e,"network-security-config");this.addNetwork2Node(t);const i=path.resolve(this._pathInfo.getShellSrcMain(),"res","xml","network_security_config.xml");fs.outputFileSync(i,this._builder.build(e.build()))}addIconLabel(e){var t,i,o,d;let s,a;const n=null===(i=null===(t=this._configObj)||void 0===t?void 0:t.module)||void 0===i?void 0:i.abilities;if(this._moduleType===module_type_enum_js_1.ModuleType.Entry&&n)for(const e of n){const t=e.skills;if(t)for(const i of t){const t=i.actions,o=i.entities;t&&o&&t.includes("action.system.home")&&o.includes("entity.system.home")&&(a=e.label,s=e.icon)}}if(s&&this._moduleType===module_type_enum_js_1.ModuleType.Entry&&"ohosTest"!==(null===(o=this._targetData)||void 0===o?void 0:o.getTargetName())&&void 0===e.getAttr("android:icon")&&e.addAttr("android:icon",s),a&&this._moduleType===module_type_enum_js_1.ModuleType.Entry&&"ohosTest"!==(null===(d=this._targetData)||void 0===d?void 0:d.getTargetName())&&void 0===e.getAttr("android:label")&&e.addAttr("android:label",a),void 0===e.getAttr("android:icon")&&this._moduleType===module_type_enum_js_1.ModuleType.Entry){e.addAttr("android:icon","@drawable/default_icon");const t=path.resolve(this._pathInfo.getShellResourceDir(),"drawable","default_icon.png");fs.copyFileSync(`${__dirname}/../../../res/template/photo/default_icon.png`,t)}}addDeviceConfig2Node(e){var t,i,o,d,s,a;let n={};(null===(t=this._configObj)||void 0===t?void 0:t.deviceConfig.default)&&(n=null===(i=this._configObj)||void 0===i?void 0:i.deviceConfig.default);const r=this.configRule.deviceConfig.default;e.addAttr(r.keepAlive,!!n.keepAlive).addAttr(r.directLaunch,!!n.directLaunch).addAttr(r.process,n.process),e.addAttr(r.supportBackup,!!n.supportBackup);const l=e.getParent();if(n.jointUserId&&void 0!==l&&("ohos.uid.system"===n.jointUserId?l.addAttr(r.jointUserId,"android.uid.system"):l.addAttr(r.jointUserId,n.jointUserId)),n.ark){const t=r.ark,i=t.reqVersion;n.ark.reqVersion&&e.addNode("meta-data",xml_utils_1.XMLNode.initByAttrs({"android:name":i.compatible,"android:value":n.ark.reqVersion.compatible})).addNode("meta-data",xml_utils_1.XMLNode.initByAttrs({"android:name":i.target,"android:value":n.ark.reqVersion.target})),n.ark.flag&&e.addNode("meta-data",xml_utils_1.XMLNode.initByAttrs({"android:name":t.flag,"android:value":n.ark.flag}))}const u=r.network;if(e.addAttr(u.cleartextTraffic,!!(null===(o=n.network)||void 0===o?void 0:o.cleartextTraffic)),(null===(d=n.network)||void 0===d?void 0:d.securityConfig)&&e.addAttr(u.securityConfig,"@xml/network_security_config"),n.allowComponentsProxy){const t=null===(a=null===(s=this._configObj)||void 0===s?void 0:s.module)||void 0===a?void 0:a.package;e.addAttr("tools:replace",r.allowComponentsProxy).addAttr(r.allowComponentsProxy,`${t}.ShellComponentProxy`)}}addModule2Node(e,t){var i,o,d,s,a;const n=this.configRule.module,r=n.distro,l=null===(i=this._configObj)||void 0===i?void 0:i.module;if(l){if(this._moduleType===module_type_enum_js_1.ModuleType.Feature){t.addAttr(r.moduleType,!0).addAttr(r.moduleName,l.distro.moduleName);const e=xml_utils_1.XMLNode.initByParent(t,"dist:delivery");l.distro.deliveryWithInstall?e.addNode("dist:install-time",new xml_utils_1.XMLNode):e.addNode("dist:on-demand",new xml_utils_1.XMLNode)}(null===(o=l.description)||void 0===o?void 0:o.startsWith("$"))&&e.addAttr(n.description,l.description),(null===(d=l.entryTheme)||void 0===d?void 0:d.startsWith("$"))&&e.addAttr(n.entryTheme,l.entryTheme),this._configObj.module.abilities&&this.addAbilities2Node(this._configObj.module.abilities,e),null===(a=null===(s=l.metaData)||void 0===s?void 0:s.customizeData)||void 0===a||a.forEach((t=>{this.addCustomizeData2Node(t,e)}))}}addAbilities2Node(e,t){const i=this.configRule.module.ability;null==e||e.forEach((e=>{var o,d;let s="activity";e.targetAbility&&""!==e.targetAbility&&(s="activity-alias"),"service"!==e.type&&"CA"!==e.type||(s="service"),"data"===e.type&&(s="provider");const a=xml_utils_1.XMLNode.initByParent(t,s);"service"===e.type&&e.description&&e.description.startsWith("$")&&a.addAttr(i.description,e.description),a.addAttr(i.icon,e.icon).addAttr(i.label,e.label),null===(d=null===(o=null==e?void 0:e.metaData)||void 0===o?void 0:o.customizeData)||void 0===d||d.forEach((e=>{this.addCustomizeData2Node(e,a)}));const n=shell_utils_js_1.ShellUtils.getShellActivity(e,this._moduleTargetRes.supportLiteDeviceModule(),this._configObj.module.package);if(a.addAttr("android:name",n),e.permissions&&a.addAttr("android:permission",(0,lodash_1.uniq)(e.permissions).join("|")),e.skills&&this.addSkills2Node(e.skills,a),"data"===e.type&&e.uri){const t=e.uri.substring(e.uri.lastIndexOf("/")+1);a.addAttr("android:authorities",t)}else if(e.uri&&0!==e.uri.length){xml_utils_1.XMLNode.initByParent(a,"intent-filter").addNode("data",xml_utils_1.XMLNode.initByAttrs({"android:authorities":e.uri}))}["CA","service","data"].includes(e.type)&&a.addAttr(i.visible,e.visible);const r=i.backgroundModes;if(e.backgroundModes){const t=(0,lodash_1.uniq)(e.backgroundModes).filter((e=>Object.keys(r).includes(e))).map((e=>r[e]));a.addAttr("android:foregroundServiceType",t.join("|"))}a.addAttr(i.process,e.process);const l=i.configChanges;if(e.configChanges){const t=(0,lodash_1.uniq)(e.configChanges).map((e=>l[e]));a.addAttr("android:configChanges",t.join("|"))}"data"===e.type&&this.handleDataAbility(a,e),"page"===e.type&&GenerateShellManifest.handlePageAbility(t,a,e,i),a.addAttr("android:exported",e.visible)}))}handleDataAbility(e,t){var i;if(e.addAttr("android:singleUser",t.multiUserShared).addAttr("android:readPermission",t.readPermission).addAttr("android:writePermission",t.writePermission).addAttr("android:grantUriPermissions",null===(i=t.grantPermission)||void 0===i?void 0:i.toString()),t.uriPermission){const i=xml_utils_1.XMLNode.initByParent(e,"grant-uri-permission"),o=t.uriPermission.mode,d=t.uriPermission.path;d||this._log.errorMessageExit("uriPermission in the config.json file cannot be left empty.");let s="android:path";"prefix"===o&&(s="android:pathPrefix"),"pattern"===o&&(s="android:pathPattern"),i.addAttr(s,d)}}static handlePageAbility(e,t,i,o){var d,s,a;const n={unspecified:"unspecified",landscape:"landscape",portrait:"portrait",followRecent:"behind"},r={standard:"standard",singleton:"singleInstance",singleMission:"singleTask"};i.orientation&&n[i.orientation]&&t.addAttr(o.orientation,n[i.orientation]),i.launchType&&r[i.launchType]&&t.addAttr(o.launchType,r[i.launchType]),t.addAttr(o.resizeable,null===(d=i.resizeable)||void 0===d?void 0:d.toString()).addAttr(o.mission,i.mission).addAttr(o.supportPipMode,null===(s=i.supportPipMode)||void 0===s?void 0:s.toString()).addAttr("android:windowSoftInputMode","adjustResize"),(i.formsEnabled||i.formEnabled)&&xml_utils_1.XMLNode.initByParent(e,"service").addAttr(o.name,`${i.name}ShellServiceForm`).addAttr(o.visible,i.visible).addAttr(o.process,i.process),(null===(a=i.entryTheme)||void 0===a?void 0:a.startsWith("$"))&&t.addAttr("android:theme",i.entryTheme),i.targetAbility&&""!==i.targetAbility&&t.addAttr(o.targetAbility,`${i.targetAbility}targetAbility`)}addSkills2Node(e,t){const i=this.configRule.module.ability.skills;let o;e.forEach((e=>{var d,s,a;null===(d=e.actions)||void 0===d||d.forEach((e=>{var d,s,a;if(null===(a=null===(s=null===(d=this._configObj)||void 0===d?void 0:d.module)||void 0===s?void 0:s.distro)||void 0===a?void 0:a.installationFree)return;o||(o=xml_utils_1.XMLNode.initByParent(t,"intent-filter"));const n=i.actions[e]?i.actions[e]:e;o.addNode("action",xml_utils_1.XMLNode.initByAttrs({"android:name":n}))})),null===(s=e.entities)||void 0===s||s.forEach((e=>{var d;if(null===(d=this._configObj)||void 0===d?void 0:d.module.distro.installationFree)return;o||(o=xml_utils_1.XMLNode.initByParent(t,"intent-filter"));const s=i.entities[e]?i.entities[e]:e;o.addNode("category",xml_utils_1.XMLNode.initByAttrs({"android:name":s}))})),null===(a=e.uris)||void 0===a||a.forEach((e=>{o||(o=xml_utils_1.XMLNode.initByParent(t,"intent-filter"));const d=xml_utils_1.XMLNode.initByParent(o,"data");e.type||e.scheme||this._log.errorMessageExit("skills.uris.scheme in the config.json file cannot be null when uris.type is empty."),"dataability"===e.scheme?d.addAttr(i.uris.scheme,"content"):d.addAttr(i.uris.scheme,e.scheme),d.addAttr(i.uris.host,e.host).addAttr(i.uris.port,e.port).addAttr(i.uris.path,e.path).addAttr(i.uris.pathStartWith,e.pathStartWith).addAttr(i.uris.pathRegx,e.pathRegx).addAttr(i.uris.type,e.type)}))}))}addDefPermissionInfo2Node(e,t){var i;const o=this.configRule.module.defPermissions;null===(i=e.defPermissions)||void 0===i||i.forEach((e=>{var i,d,s,a,n,r,l,u,c;const m=xml_utils_1.XMLNode.initByParent(t,"permission"),h=[];"user_grant"===e.grantMode?(h.push("dangerous"),(null===(i=e.availableScope)||void 0===i?void 0:i.includes("signature"))&&h.push("signature"),(null===(d=e.availableScope)||void 0===d?void 0:d.includes("privileged"))&&h.push("privileged"),(null===(s=e.availableScope)||void 0===s?void 0:s.includes("system"))&&h.push("system")):"system_grant"===e.grantMode||void 0===e.grantMode?((null===(a=e.availableScope)||void 0===a?void 0:a.includes("restricted"))&&h.push("normal"),(null===(n=e.availableScope)||void 0===n?void 0:n.includes("signature"))&&h.push("signature"),(null===(r=e.availableScope)||void 0===r?void 0:r.includes("privileged"))&&h.push("privileged"),(null===(l=e.availableScope)||void 0===l?void 0:l.includes("system"))&&h.push("system"),(null===(u=e.availableScope)||void 0===u?void 0:u.includes(""))&&h.push("normal"),0===h.length&&h.push("normal")):this._log.warn("Invalid grantMode value under defPermissions in the config.json file."),m.addAttr(o.name,e.name).addAttr(o.group,e.group).addAttr(o.label,e.label).addAttr(o.availableScope,(0,lodash_1.uniq)(h).join("|")),(null===(c=e.description)||void 0===c?void 0:c.startsWith("$"))&&m.addAttr(o.description,e.description)}))}addReqPermissionsInfo2Node(e,t){var i;const o=this.configRule.module.reqPermissions;null===(i=e.reqPermissions)||void 0===i||i.forEach((e=>{const i=o[e.name]?o[e.name]:e.name;t.addNode("uses-permission",xml_utils_1.XMLNode.initByAttrs({"android:name":i}))}))}addDefPermissionGroupsInfo2Node(e,t){var i;const o=this.configRule.module.defPermissionGroups;null===(i=e.defPermissionGroups)||void 0===i||i.forEach((e=>{var i;const d=xml_utils_1.XMLNode.initByParent(t,"permission-group");d.addAttr(o.name,e.name).addAttr(o.icon,e.icon).addAttr(o.label,e.label).addAttr(o.order,e.order).addAttr(o.request,e.request),(null===(i=e.description)||void 0===i?void 0:i.startsWith("$"))&&d.addAttr(o.description,e.description)}))}addNetwork2Node(e){var t,i,o,d;const s=null===(i=null===(t=this._configObj)||void 0===t?void 0:t.deviceConfig.default)||void 0===i?void 0:i.network;if(null===(o=null==s?void 0:s.securityConfig)||void 0===o?void 0:o.domainSettings){const t=s.securityConfig.domainSettings,i=xml_utils_1.XMLNode.initByAttrsAndParent({cleartextTrafficPermitted:t.cleartextPermitted},e,"domain-config");null===(d=t.domains)||void 0===d||d.forEach((e=>{xml_utils_1.XMLNode.initByAttrsAndParent({includeSubdomains:e.subdomains},i,"domain").addValue(e.name)}))}}addCustomizeData2Node(e,t){let[i,o]=[e.name,e.extra];if("AOSP-theme"===i)return void t.addAttr("android:theme",e.value);const d=this.configRule.module.ability.metaData,s=xml_utils_1.XMLNode.initByParent(t,"meta-data"),a=o?o.substring(o.lastIndexOf(":")+1):"",n=`${a}.json`;"ohos.miscservices.inputmethodability"===i&&(o&&this.handleInputMethod(n,a),i="android.view.im"),"ohos.accessibleability"===i&&(o&&this.handleAccessibilityConfig(n,a),i="android.accessibilityservice"),s.addAttr(d.name,i).addAttr(d.value,e.value).addAttr(d.extra,o)}handleInputMethod(e,t){const i=this.moduleModel.getSourceSetByTargetName(this._targetData.getTargetName()).getTargetResPath(),o=path.resolve(i,"base","profile",e);fs.existsSync(o)||this._log.errorMessageExit(`File ${o} not found.`);const d=path.resolve(this._pathInfo.getShellResourceDir(),"xml");fs.ensureDirSync(d);const s=path.resolve(d,`${t}.xml`),a=new xml_utils_1.XMLNode;a.addPI();const n=fs.readJsonSync(o)["input-method"],r=xml_utils_1.XMLNode.initByAttrsAndParent({"xmlns:android":"http://schemas.android.com/apk/res/android","android:settingsActivity":`${n.settingAbility}ShellActivity`,"android:supportsSwitchingToNextInputMethod":n.supportsAdvancingToNext},a,"input-method");n.keyboardType.forEach((e=>{r.addNode("subtype",xml_utils_1.XMLNode.initByAttrs({"android:label":e.label,"android:languageTag":e.language,"android:isAsciiCapable":e.supportAscii,"android:icon":e.icon,"android:imeSubtypeMode":e.inputSource,"android:imeSubtypeExtraValue":e.customizedValue}))})),fs.outputFileSync(s,this._builder.build(a.build())),fs.removeSync(path.resolve(this._pathInfo.getShellResourceDir(),"raw",e))}handleAccessibilityConfig(e,t){const i=this.moduleModel.getSourceSetByTargetName(this._targetData.getTargetName()).getTargetResPath(),o=path.resolve(i,"base","profile",e);fs.existsSync(o)||this._log.errorMessageExit(`File ${o} not found.`);const d=path.resolve(this._pathInfo.getShellResourceDir(),"xml");fs.ensureDirSync(d);const s=path.resolve(d,`${t}.xml`),a=this.configRule.module.ability.metaData,n=new xml_utils_1.XMLNode;n.addPI();const r=xml_utils_1.XMLNode.initByAttrsAndParent({"xmlns:android":"http://schemas.android.com/apk/res/android"},n,"accessibility-service"),l=fs.readJsonSync(o);for(const e of Object.keys(l)){const t=Array.isArray(l[e])?l[e]:[l[e]];switch(e){case"accessibilityEventTypes":case"accessibilityAbilityType":r.addAttr(a[e],t.map((t=>void 0===a[`${e}Values`][t]?t:a[`${e}Values`][t])).join("|"));break;case"targetBundleNames":r.addAttr(a[e],t.join(","));break;case"accessibilityCapabilities":t.forEach((t=>{r.addAttr(void 0===a[`${e}Values`][t]?t:a[`${e}Values`][t],"true")}));break;default:t.forEach((t=>{const i=void 0===a[e]?e:a[e];r.addAttr(i,t)}))}}fs.outputFileSync(s,this._builder.build(n.build()))}}exports.GenerateShellManifest=GenerateShellManifest;