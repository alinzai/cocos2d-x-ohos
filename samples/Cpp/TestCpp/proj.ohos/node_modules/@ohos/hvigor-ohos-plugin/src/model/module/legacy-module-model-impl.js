"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyModuleModelImpl=void 0;const array_util_js_1=require("../../utils/array-util.js"),legacy_target_source_set_impl_js_1=require("../source-set/legacy-target-source-set-impl.js"),legacy_ability_model_impl_js_1=require("../ability/legacy-ability-model-impl.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),path_1=__importDefault(require("path")),core_module_model_impl_js_1=require("./core-module-model-impl.js"),fs_1=__importDefault(require("fs")),project_file_reader_js_1=require("../../utils/project-file-reader.js"),legacy_form_model_impl_js_1=require("../ability/legacy-form-model-impl.js"),common_const_js_1=require("../../const/common-const.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),defaultTargetName=common_const_js_1.DefaultTargetConst.DEFAULT_TARGET,ohosTestTargetName=common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET,_log=ohos_logger_js_1.OhosLogger.getLogger("legacyModuleModel");class LegacyModuleModelImpl extends core_module_model_impl_js_1.CoreModuleModelImpl{constructor(e,t){super(e,t)}static validateSameNameAbility(e){const t=ohos_logger_js_1.OhosLogger.getLogger("Ability"),o=(0,array_util_js_1.findDuplicateElement)(e.map((e=>e.getName())));o.length>0&&(o.forEach((e=>t.error(`Duplicate ability name ${e}.`))),t.errorMessageExit("Check the ability name in the config.json file and make sure it is unique."))}initDefaultTargetSourceSet(){const e=new legacy_target_source_set_impl_js_1.LegacyTargetSourceSetImpl(path_1.default.resolve(this._sourceRootDir,"main"));this.targetSourceSetMap.set(defaultTargetName,e);if((0,array_util_js_1.getElementFromArr)(this.getProfileOpt().targets,ohosTestTargetName)){const e=new legacy_target_source_set_impl_js_1.LegacyTargetSourceSetImpl(path_1.default.resolve(this._sourceRootDir,ohosTestTargetName));this.targetSourceSetMap.set(ohosTestTargetName,e)}}getLegacyAbilities(e=defaultTargetName){this._legacyAbilitiesMap||(this._legacyAbilitiesMap=new Map,this.initAbilityInfo(defaultTargetName,this.targetSourceSetMap.get(defaultTargetName)),e===ohosTestTargetName&&this.initAbilityInfo(ohosTestTargetName,this.targetSourceSetMap.get(ohosTestTargetName)));const t=this._legacyAbilitiesMap.get(e);return void 0===t?this._legacyAbilitiesMap.get("default"):t}getModuleType(e=defaultTargetName){var t,o;const a=this.getSourceSetByTargetName(e),r=null===(o=null===(t=a.getLegacyModuleTargetRes().getConfigJsonOpt().module)||void 0===t?void 0:t.distro)||void 0===o?void 0:o.moduleType;return void 0===r&&_log._buildError("Unable to obtain the module type.")._solution("Make sure the module/distro/moduleType field is set correctly in the config.json file.")._file(a.getLegacyModuleTargetRes().getJsonPath())._printErrorAndExit(),module_type_enum_js_1.ModuleType.valueOf(r)}getDeviceTypes(){return this.getSourceSetByTargetName().getLegacyModuleTargetRes().getConfigJsonOpt().module.deviceType}getSourceSetByTargetName(e=defaultTargetName){return this.targetSourceSetMap.has(e)?this.targetSourceSetMap.get(e):this.targetSourceSetMap.get(defaultTargetName)}getJsonObjByTargetName(e){return this.getSourceSetByTargetName(e).getLegacyModuleTargetRes().getConfigJsonOpt()}getJsonPathByTargetName(e){return this.getSourceSetByTargetName(e).getLegacyModuleTargetRes().getJsonPath()}isAtomicService(){var e,t;return this.isInstallFree()||(null===(t=null===(e=this.getJsonObjByTargetName(defaultTargetName).module)||void 0===e?void 0:e.abilities)||void 0===t?void 0:t.some((e=>"service"===e.type&&e.formsEnabled)))||!1}isInstallFree(){return this.getJsonObjByTargetName(defaultTargetName).module.distro.installationFree||!1}initAbilityInfo(e,t){const o=t.getLegacyModuleTargetRes().getJsonPath();if(!fs_1.default.existsSync(o))return;const a=project_file_reader_js_1.ProjectFileReader.getJson5Obj(o),r=a.module.abilities?a.module.abilities:[],l=[];for(let e=0;e<r.length;e++)l.push(new legacy_ability_model_impl_js_1.LegacyAbilityModelImpl(o,r[e].name));LegacyModuleModelImpl.validateSameNameAbility(l);const i=a.module.js?a.module.js:[];for(let e=0;e<i.length;e++)"form"===i[e].type&&l.push(new legacy_form_model_impl_js_1.LegacyFormModelImpl(o,i[e]));LegacyModuleModelImpl.validateFormUnique(r),this._legacyAbilitiesMap.set(e,l)}static validateFormUnique(e){const t=ohos_logger_js_1.OhosLogger.getLogger("Form"),o=e.map((e=>e.forms?e.forms.map((e=>e.name)):[])).flat(),a=(0,array_util_js_1.findDuplicateElement)(o);a.length>0&&(a.forEach((e=>t.error(`Duplicate form name ${e}.`))),t.errorMessageExit("Check the form name in the config.json file and make sure it is unique."))}}exports.LegacyModuleModelImpl=LegacyModuleModelImpl;