"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,l){void 0===l&&(l=a);var i=Object.getOwnPropertyDescriptor(t,a);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,l,i)}:function(e,t,a,l){void 0===l&&(l=a),e[l]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GenerateJavaFiles=void 0;const fse=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),runtime_type_enum_js_1=require("../../enum/runtime-type-enum.js"),legacy_form_model_impl_js_1=require("../../model/ability/legacy-form-model-impl.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),task_names_js_1=require("../common/task-names.js"),ohos_hap_task_js_1=require("../task/ohos-hap-task.js"),file_util_js_1=require("../../utils/file-util.js"),os_1=__importDefault(require("os")),fs_1=__importDefault(require("fs"));var ShellTask=task_names_js_1.TaskNames.ShellTask;const legacy_pre_build_js_1=require("../legacy-tasks/legacy-pre-build.js");class GenerateJavaFiles extends ohos_hap_task_js_1.OhosHapTask{constructor(e){super(e,ShellTask.GENERATE_SHELL_JAVA_FILES)}initTaskDepends(){this.module.registryDependsOnTask(this,new legacy_pre_build_js_1.LegacyPreBuild(this.targetService))}taskShouldDo(e){return e.getTargetStatus().is(runtime_type_enum_js_1.RuntimeTypeEnum.HARMONY_OS)}beforeTask(e){fse.emptyDirSync(e.getPathInfo().getIntermediatesJavaDir()),fse.emptyDirSync(e.getPathInfo().getIntermediatesShellJavaDir())}doTaskAction(e){var t,a;const l=this.service.getModuleModel(),i=l.getJsonObjByTargetName(e.getTargetName()),s=new JavaFileCreator(e.getPathInfo(),i),r=l.getLegacyAbilities(e.getTargetName());for(let e=0;e<r.length;e++)r[e]instanceof legacy_form_model_impl_js_1.LegacyFormModelImpl||(s.createJavaFileByAbility(r[e]),s.createShellJavaFileByAbility(r[e]));s.createShellAppJavaFile(),"ohosTest"===e.getTargetName()&&s.copyTestRunnerFile(),!0===(null===(a=null===(t=i.deviceConfig)||void 0===t?void 0:t.default)||void 0===a?void 0:a.allowComponentsProxy)&&s.copyShellComponentProxy(),this.outputJavaList(e.getPathInfo().getIntermediatesJavaDir(),s.getJavaFiles()),this.outputJavaList(e.getPathInfo().getIntermediatesShellJavaDir(),s.getShellJavaFiles())}outputJavaList(e,t){const a=path_1.default.resolve(e,"javaList");file_util_js_1.FileUtil.checkDirWithoutDelete(e),file_util_js_1.FileUtil.checkFile(a),fs_1.default.writeFileSync(a,t.join(os_1.default.EOL))}}exports.GenerateJavaFiles=GenerateJavaFiles;class JavaFileCreator{constructor(e,t){this._pathInfo=e,this._packageName=t.module.package,this._moduleName=t.module.name,this._javaFiles=[],this._shellJavaFiles=[]}getJavaFiles(){return this._javaFiles}getShellJavaFiles(){return this._shellJavaFiles}getShellFileNameByAbilityType(e,t){switch(e){case"page":return`${t}ShellActivity`;case"form":case"service":return`${t}ShellService`;case"data":return`${t}ShellProvider`;default:throw ohos_logger_js_1.OhosLogger.getLogger("abilityEnum")._printErrorAndExit(`Invalid ability type: ${e}`),new Error}}createShellAppJavaFile(){const e=path_1.default.resolve(__dirname,"../../../res/template/ability/shell/app-shell.temp");let t=fse.readFileSync(e).toString();const a=`Shell${"."===this._moduleName.charAt(0)?this._moduleName.substring(1):this._moduleName}`;t=t.replace("APPLICATION_NAME",a),t=t.replace("PACKAGE_NAME",this._packageName);const l=this._packageName.replace(/\./g,"/"),i=path_1.default.resolve(this._pathInfo.getIntermediatesShellJavaDir(),l,`${a}.java`);fse.outputFileSync(i,t),this._shellJavaFiles.push(i)}createShellJavaFileByAbility(e){const t=e.getType(),a=path_1.default.resolve(__dirname,`../../../res/template/ability/shell/${t}-shell.temp`);let l=fse.readFileSync(a).toString();const i="."===e.getName().charAt(0)?e.getName().substring(1):e.getName(),s=this.getShellFileNameByAbilityType(t,i);l=l.replace("SHELL_NAME",s),l=l.replace("PACKAGE_NAME",this._packageName);const r=this._packageName.replace(/\./g,"/"),o=path_1.default.resolve(this._pathInfo.getIntermediatesShellJavaDir(),r,`${s}.java`);fse.outputFileSync(o,l),this._shellJavaFiles.push(o)}createJavaFileByAbility(e){const t=e.getType(),a=path_1.default.resolve(__dirname,`../../../res/template/ability/${t}.temp`);let l=fse.readFileSync(a).toString();const i="."===e.getName().charAt(0)?e.getName().substring(1):e.getName();l=l.replace("ABILITY_NAME",i),l=l.replace("PACKAGE_NAME",this._packageName),l=l.replace("ABILITY_SRC_PATH",e.getRelateSrcPath());const s=this._packageName.replace(/\./g,"/"),r=path_1.default.resolve(this._pathInfo.getIntermediatesJavaDir(),s,`${i}.java`);fse.outputFileSync(r,l),this._javaFiles.push(r)}copyTestRunnerFile(){const e=path_1.default.resolve(__dirname,"../../../res/template/test/Runner.temp"),t=path_1.default.resolve(this._pathInfo.getIntermediatesJavaDir(),"ohos/testkit/runner/Runner.java");fse.outputFileSync(t,fse.readFileSync(e).toString()),this._javaFiles.push(t)}copyShellComponentProxy(){let e=fse.readFileSync(path_1.default.resolve(__dirname,"../../../res/template/touch/ShellComponentProxy.temp"),{encoding:"utf-8"});e=e.replace("PACKAGE_NAME",this._packageName);const t=this._packageName.replace(/\./g,"/"),a=path_1.default.resolve(this._pathInfo.getIntermediatesShellJavaDir(),t,"ShellComponentProxy.java");fse.outputFileSync(a,e),this._shellJavaFiles.push(a)}}