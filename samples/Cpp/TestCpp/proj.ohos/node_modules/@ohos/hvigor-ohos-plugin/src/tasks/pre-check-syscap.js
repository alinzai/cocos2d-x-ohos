"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PreCheckSyscap=void 0;const ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),project_file_reader_js_1=require("../utils/project-file-reader.js"),path_1=__importDefault(require("path")),common_const_js_1=require("../const/common-const.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),array_util_js_1=require("../utils/array-util.js"),fs_1=__importDefault(require("fs")),validate_util_js_1=require("../utils/validate-util.js");class PreCheckSyscap extends ohos_hap_task_js_1.OhosHapTask{constructor(e,o){var s;super(e,o),this._log=ohos_logger_js_1.OhosLogger.getLogger(PreCheckSyscap.name);const t=e.getTargetData().getTargetName();this.sourceRoot=null===(s=this.service.getModuleModel())||void 0===s?void 0:s.getSourceRootByTargetName(t),this.jsonFilePath=path_1.default.resolve(this.sourceRoot,this.service.isFaMode()?common_const_js_1.CommonConst.CONFIG_JSON:common_const_js_1.CommonConst.MODULE_JSON5),this.syscapJsonPath=path_1.default.resolve(this.sourceRoot,common_const_js_1.CommonConst.SYSCAP_JSON)}doTaskAction(e){if(fs_1.default.existsSync(this.syscapJsonPath)){const e=this.getJsonProfileByModel(this.service,this.jsonFilePath),o=project_file_reader_js_1.ProjectFileReader.getJson5Obj(this.syscapJsonPath),s=o.devices,t=s.general;if(0===e.deviceTypes.length){if(void 0!==t&&0!==t.length){const o=`The value of 'general' in the syscap.json file must be the same as that of '${e.deviceConfig}' in the ${e.configurationProfile} file.`,s=`Please check whether the general field in the syscap.json file and the ${e.deviceConfig} field in the ${e.configurationProfile}\n          are the same.`;this._log._buildError(o)._solution(s)._file(this.syscapJsonPath)._printErrorAndExit()}}else if(void 0===t||!(0,array_util_js_1.checkArrayElementIsSame)(t,e.deviceTypes)){const o="Unable to find the 'general' field or its value is invalid.",s=`Make sure the 'general' field is contained in the syscap.json file and its value must be the same as the value of '${e.deviceConfig}' in the ${e.configurationProfile} file.`;this._log._buildError(o)._solution(s)._file(this.syscapJsonPath)._printErrorAndExit()}const i=/^SystemCapability(\.[a-zA-Z0-9]+){2,3}$/;s.custom.forEach((e=>{Object.keys(e).forEach((o=>{e[o].forEach((e=>{validate_util_js_1.ValidateUtil.fieldRegExpCheck(e,"custom",i,this.syscapJsonPath)}))}))})),this.productionRegexpCheck(o,i,common_const_js_1.CommonConst.ADDED_SYSCAPS),this.productionRegexpCheck(o,i,common_const_js_1.CommonConst.REMOVED_SYSCAPS)}}initTaskDepends(){}getJsonProfileByModel(e,o){let s;return e.isFaMode()?(s=project_file_reader_js_1.ProjectFileReader.getJson5Obj(o),{jsonFilePath:this.jsonFilePath,profile:s,deviceTypes:s.module.deviceType,deviceConfig:common_const_js_1.CommonConst.DEVICETYPE,configurationProfile:common_const_js_1.CommonConst.CONFIG_JSON}):(s=project_file_reader_js_1.ProjectFileReader.getJson5Obj(o),{jsonFilePath:this.jsonFilePath,profile:s,deviceTypes:s.module.deviceTypes,deviceConfig:common_const_js_1.CommonConst.DEVICETYPES,configurationProfile:common_const_js_1.CommonConst.MODULE_JSON5})}productionRegexpCheck(e,o,s){const t=e.production;void 0!==t&&void 0!==t[s]&&0!==t[s].length&&t[s].forEach((e=>{switch(s){case common_const_js_1.CommonConst.ADDED_SYSCAPS:validate_util_js_1.ValidateUtil.fieldRegExpCheck(e,common_const_js_1.CommonConst.ADDED_SYSCAPS,o,this.syscapJsonPath);break;case common_const_js_1.CommonConst.REMOVED_SYSCAPS:validate_util_js_1.ValidateUtil.fieldRegExpCheck(e,common_const_js_1.CommonConst.REMOVED_SYSCAPS,o,this.syscapJsonPath)}}))}}exports.PreCheckSyscap=PreCheckSyscap;