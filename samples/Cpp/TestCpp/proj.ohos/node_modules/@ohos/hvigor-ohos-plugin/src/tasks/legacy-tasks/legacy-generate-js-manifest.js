"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,r)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyGenerateJsManifest=void 0;const file_set_js_1=require("@ohos/hvigor-base/src/internal/snapshot/util/file-set.js"),crypto_1=require("crypto"),lodash_1=require("lodash"),path=__importStar(require("path")),fse=__importStar(require("fs-extra")),ohos_hap_task_js_1=require("../task/ohos-hap-task.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),hvigor_base_1=require("@ohos/hvigor-base"),inject_const_js_1=require("../../const/inject-const.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),ability_type_enum_js_1=require("../../enum/ability-type-enum.js"),task_names_js_1=require("../common/task-names.js");var LegacyFATask=task_names_js_1.TaskNames.LegacyFATask;const legacy_pre_build_js_1=require("./legacy-pre-build.js"),SRC_PATH=inject_const_js_1.InjectConst.PREVIEWER_REPLACE_SRC_PATH,PAGE=inject_const_js_1.InjectConst.PREVIEWER_REPLACE_PAGE,BUILD_ROOT=inject_const_js_1.InjectConst.BUILD_ROOT;class LegacyGenerateJsManifest extends ohos_hap_task_js_1.OhosHapTask{constructor(e){super(e,LegacyFATask.GENERATE_JS_MANIFEST),this._log=ohos_logger_js_1.OhosLogger.getLogger(LegacyGenerateJsManifest.name),this.previewSrcPath=hvigor_base_1.hvigor.getExtraConfig().get(SRC_PATH),this.previewPage=hvigor_base_1.hvigor.getExtraConfig().get(PAGE),this.isPreview=hvigor_base_1.hvigor.getExtraConfig().get(BUILD_ROOT)===build_directory_const_js_1.BuildDirConst.PREVIEW_BUILD_PATH,this._moduleModel=this.service.getModuleModel(),this._abilityModels=this._moduleModel.getLegacyAbilities(this.targetData.getTargetName()),this._configOpt=(0,lodash_1.cloneDeep)(this._moduleModel.getJsonObjByTargetName(this.targetData.getTargetName())),this._minPlatformVersion=this._moduleModel.getParentProject().getProfileOpt().app.compatibleSdkVersion}initTaskDepends(){this.module.registryDependsOnTask(this,new legacy_pre_build_js_1.LegacyPreBuild(this.targetService))}declareInputs(){var e;const t=new Map,i=null===(e=this.targetData.getTargetOpt().source)||void 0===e?void 0:e.abilities,s=JSON.stringify(i||[]),r=(0,crypto_1.createHash)("MD5").update(JSON.stringify(this._abilityModels)).digest("hex"),a=(0,crypto_1.createHash)("MD5").update(JSON.stringify(this._configOpt)).digest("hex"),o=(0,crypto_1.createHash)("MD5").update(s).digest("hex");return t.set("ABI_OBJ_HASH",r),t.set("CONFIG_OBJ",a),t.set("ABILITIES_HASH",o),t.set("HAS_LITE_DEVICE",this.service.hasLiteDevice()),t.set("MIN_PLATFORM_VERSION",this._minPlatformVersion),this.isPreview&&(t.set("PREVIEWER_REPLACE_PAGE",JSON.stringify(hvigor_base_1.hvigor.getExtraConfig().get(PAGE))),t.set("PREVIEWER_REPLACE_SRCPATH",JSON.stringify(hvigor_base_1.hvigor.getExtraConfig().get(SRC_PATH)))),t}declareOutputFiles(){return(new file_set_js_1.FileSet).addEntry(this.targetData.getPathInfo().getIntermediatesLegacyManifestJson())}doTaskAction(e){for(const t of this._abilityModels)t.getType()!==ability_type_enum_js_1.AbilityTypeEnum.PAGE&&t.getType()!==ability_type_enum_js_1.AbilityTypeEnum.FORM||this.generateJsonInfo(t,this._configOpt,e)}getManifestPages(e,t){var i;if(!this.isPreview||!this.previewPage||this.previewSrcPath&&this.previewSrcPath!==t.getRelateSrcPath()){let s=this.getAbilityPages(e,t);return void 0===s&&(s=null===(i=t.getConfigJsonJsObj())||void 0===i?void 0:i.pages),s||[]}return this._log.debug(`replace ${this.previewPage} for ${this.previewSrcPath} manifest.`),[this.previewPage]}getAbilityPages(e,t){const i=e.findTargetConfigOpt(t);if(i)return i.pages}generateJsonInfo(e,t,i){var s,r;let a={appID:t.app.bundleName,versionName:t.app.version.name,versionCode:t.app.version.code,minPlatformVersion:this._minPlatformVersion,appName:LegacyGenerateJsManifest.findAppName(t),deviceType:t.module.deviceType,window:this.getWindowObj(e),pages:this.getManifestPages(i,e)};const o=null===(s=e.getConfigJsonJsObj())||void 0===s?void 0:s.mode,n=e.getType()===ability_type_enum_js_1.AbilityTypeEnum.FORM?ability_type_enum_js_1.AbilityTypeEnum.FORM:null===(r=e.getConfigJsonJsObj())||void 0===r?void 0:r.type;o?a={...a,mode:o}:n&&(a={...a,type:n}),this._log._printDebugCommand("JsManifest",a);const _=path.resolve(i.getPathInfo().getIntermediatesLegacyManifestJson(),e.getRelateSrcPath(),build_directory_const_js_1.BuildArtifactConst.LEGACY_MANIFEST_JSON);fse.outputJSONSync(_,a)}static findAppName(e){var t,i,s;const r=null!==(t=e.module.abilities)&&void 0!==t?t:[];for(const e of r)if(e.skills&&(null===(i=e.skills[0])||void 0===i?void 0:i.actions)&&"action.system.home"===(null===(s=e.skills[0])||void 0===s?void 0:s.actions[0]))return e.name;return r[0].label?r[0].label:r[0].name}getWindowObj(e){var t;if(this.service.hasLiteDevice())return;const i=null===(t=e.getConfigJsonJsObj())||void 0===t?void 0:t.window;return i||{autoDesignWidth:!1,designWidth:454}}}exports.LegacyGenerateJsManifest=LegacyGenerateJsManifest;