"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,r,s)}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyProcessProfile=void 0;const fs=__importStar(require("fs-extra")),ohos_hap_task_js_1=require("../task/ohos-hap-task.js"),project_file_reader_js_1=require("../../utils/project-file-reader.js"),task_names_js_1=require("../common/task-names.js"),legacy_merge_profile_js_1=require("./legacy-merge-profile.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js");var LegacyFATask=task_names_js_1.TaskNames.LegacyFATask;const file_set_js_1=require("@ohos/hvigor-base/src/internal/snapshot/util/file-set.js"),INPUT_KEY={arkEnable:"arkEnable",compileMode:"compileMode",deviceTypes:"deviceTypes",targetName:"targetName"};class LegacyProcessProfile extends ohos_hap_task_js_1.OhosHapTask{constructor(e){super(e,LegacyFATask.PROCESS_PROFILE),this._log=ohos_logger_js_1.OhosLogger.getLogger(LegacyProcessProfile.name),this._arkEnable=this.service.isArkModule(),this._deviceTypes=this.targetData.getTargetDeviceType(),this._intermediatesMergeLegacyProfile=this.pathInfo.getIntermediatesMergeLegacyProfile(),this._processedModuleJson=this.pathInfo.getIntermediatesProcessLegacyProfile(),this._moduleBuildProfilePath=this.moduleModel.getProfilePath()}initTaskDepends(){this.module.registryDependsOnTask(this,new legacy_merge_profile_js_1.LegacyMergeProfile(this.targetService))}doTaskAction(e){var t;const i=project_file_reader_js_1.ProjectFileReader.getJson5Obj(this._intermediatesMergeLegacyProfile);if(this._arkEnable){void 0!==i.module.distro&&(i.module.distro.virtualMachine=`ark${this.sdkInfo.getArkVersion()}`)}const r=this.moduleModel.getLegacyAbilities(this.targetData.getTargetName());this.validateTargetAbilityName(this.targetData.getTargetOpt(),r);const s=r.map((e=>this.targetData.findTargetConfigOpt(e)));this.replaceTargetAbilityPages(s,i),i.module.deviceType=this._deviceTypes;const a=null===(t=this.targetData.getTargetOpt().config)||void 0===t?void 0:t.distroFilter;a&&(i.module.distroFilter=a),fs.outputJSONSync(this._processedModuleJson,i)}replaceTargetAbilityPages(e,t){var i;for(const r of e)void 0!==r&&(null===(i=t.module.js)||void 0===i||i.forEach((e=>{e.name===r.name&&this.replaceAbilityPage(e,r)})))}replaceAbilityPage(e,t){if(void 0===t.pages)return;const i=t.pages.filter((t=>!e.pages.includes(t)));0===i.length?e.pages=t.pages:this.printInvalidError("page",i.join(","))}validateTargetAbilityName(e,t){var i,r;const s=null===(r=null===(i=null==e?void 0:e.source)||void 0===i?void 0:i.abilities)||void 0===r?void 0:r.filter((e=>!t.some((t=>e.name===t.getName())))).map((e=>e.name));s&&s.length>0&&this.printInvalidError("ability",s.join(","))}printInvalidError(e,t){this._log._buildError(`Invalid ${e} under target.`)._solution(`Check ${t} in build-profile.json5 configured in config.json.`)._file(this.moduleModel.getProfilePath())._printErrorAndExit(this.moduleModel.getName())}declareInputs(){const e=new Map;return e.set(INPUT_KEY.arkEnable,this._arkEnable),e.set(INPUT_KEY.deviceTypes,this._deviceTypes),e}declareInputFiles(){const e=new file_set_js_1.FileSet;return e.addEntry(this._intermediatesMergeLegacyProfile),e.addEntry(this._moduleBuildProfilePath),e}declareOutputFiles(){return(new file_set_js_1.FileSet).addEntry(this._processedModuleJson)}}exports.LegacyProcessProfile=LegacyProcessProfile;